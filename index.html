<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AW.Calc - Mastery & Damage</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #050505;
            --bg-card: #0f0f0f;
            --bg-input: #000000;
            --border-color: #222;
            --accent-primary: #2962ff; /* Xanh d∆∞∆°ng ƒë·∫≠m */
            --accent-glow: rgba(41, 98, 255, 0.15);
            --accent-text: #448aff;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --text-value: #e0e0e0;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-sans);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column; 
            align-items: center;    
            min-height: 100vh;
        }

        .app-container {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
            max-width: 1200px;
            width: 100%;
            flex: 1; 
        }

        /* --- C·ªòT TR√ÅI (ƒêI·ªÄU KHI·ªÇN) --- */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .brand-header { margin-bottom: 10px; }
        
        .brand-title {
            font-family: var(--font-mono);
            font-size: 20px; 
            font-weight: 800;
            color: #fff;
            margin: 0;
            letter-spacing: -0.5px;
            line-height: 1.3;
        }
        .brand-title span { color: var(--accent-primary); }
        
        .brand-subtitle {
            font-size: 11px; 
            color: var(--text-secondary);
            margin-top: 6px;
            font-weight: 500;
            line-height: 1.4;
        }

        .control-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* Tabs Styling */
        .nav-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: #050505;
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 10px;
            font-family: var(--font-sans);
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .nav-btn:hover { color: #fff; }

        .nav-btn.active {
            background-color: var(--accent-primary);
            color: #fff;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        /* Inputs Styling */
        .control-section { margin-bottom: 20px; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .label-text {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-wrapper {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0 12px;
            height: 44px;
            display: flex;
            align-items: center;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-wrapper:focus-within { 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 1px var(--accent-glow);
        }

        input, select {
            background: transparent;
            border: none;
            color: #fff;
            font-family: var(--font-mono);
            font-size: 14px;
            width: 100%;
            height: 100%;
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        select {
            color: var(--accent-text);
            font-weight: 700;
            text-align: right;
            cursor: pointer;
            min-width: 60px;
        }
        select option { background-color: #000; color: #fff; }

        .time-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* --- C·ªòT PH·∫¢I (HI·ªÇN TH·ªä) --- */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Big Timer Card */
        .timer-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .timer-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(41,98,255,0.08) 0%, rgba(0,0,0,0) 60%);
            pointer-events: none;
        }

        .timer-label {
            font-size: 11px;
            letter-spacing: 2px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 700;
            z-index: 1;
        }

        .big-time {
            font-family: var(--font-mono);
            font-size: 64px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 30px rgba(41, 98, 255, 0.2);
            line-height: 1.1;
            margin-bottom: 12px;
            z-index: 1;
        }
        
        .time-unit { font-size: 0.5em; color: var(--text-secondary); font-weight: 400; margin-right: 6px;}

        .sub-info {
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 1;
        }
        .highlight { color: var(--accent-text); font-weight: bold; margin-left: 5px; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        /* STAT CARD DESIGN */
        .stat-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border-color: #333;
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            max-width: 85%;
            line-height: 1.4;
        }
        
        .stat-icon {
            font-size: 18px;
            color: #fff; 
            opacity: 0.7;
        }

        /* Combined Row Style */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .stat-row:last-child { margin-bottom: 0; }

        .stat-col-val {
            text-align: left;
        }
        .stat-value-sm {
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
        }
        .stat-label-sm {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* M√†u ri√™ng cho Fast/Nor */
        .accent-fast { color: var(--accent-text); }
        .accent-nor { color: #aaa; }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            word-break: break-all;
            margin-bottom: 8px;
            line-height: 1.1;
        }

        .stat-sub {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: var(--font-sans);
        }

        .footer {
            margin-top: 60px;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding-bottom: 20px;
            font-weight: 500;
            font-family: var(--font-mono);
        }

        @media (max-width: 850px) {
            .app-container { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .big-time { font-size: 48px; }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- === C·ªòT TR√ÅI: NH·∫¨P LI·ªÜU === -->
        <div class="left-panel">
            <div class="brand-header">
                <h1 class="brand-title">‚öîÔ∏è Anime Weapons <span>Calc</span></h1>
                <div class="brand-subtitle">C√¥ng c·ª• t√≠nh to√°n S√°t th∆∞∆°ng, Mastery v√† Rank</div>
            </div>

            <div class="control-card">
                <!-- TABS -->
                <div class="nav-tabs">
                    <button class="nav-btn active" id="rankTabBtn" onclick="window.showSection('rank')">Rank</button>
                    <button class="nav-btn" id="masteryTabBtn" onclick="window.showSection('mastery')">Boss & Mastery</button>
                </div>

                <!-- 1. RANK INPUTS -->
                <div id="rankInputs">
                    <div class="control-section">
                        <div class="section-header">
                            <span class="label-text">RANK (0-100)</span>
                        </div>
                        <div class="input-row">
                            <div class="input-wrapper" style="flex:1;">
                                <span style="color:#666; margin-right:5px;">Hi·ªán t·∫°i</span>
                                <input type="number" id="currentRank" min="0" max="100" value="0" oninput="window.syncTargetRank()">
                            </div>
                            <div class="input-wrapper" style="flex:1;">
                                <span style="color:#666; margin-right:5px;">M·ª•c ti√™u</span>
                                <input type="number" id="targetRank" min="1" max="100" value="1" oninput="window.calculate(); window.handleInput()">
                            </div>
                        </div>
                    </div>

                    <!-- NEW: MASTERY HI·ªÜN T·∫†I -->
                    <div class="control-section">
                        <div class="section-header">
                            <span class="label-text">MASTERY ƒêANG C√ì</span>
                        </div>
                        <div class="input-row">
                            <div class="input-wrapper">
                                <input type="number" id="currentMasteryVal" placeholder="0" oninput="window.handleInput('currentMasteryVal')">
                                <select id="currentMasteryUnit" onchange="window.handleInput('currentMasteryUnit')"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. BOSS INPUTS (·∫®n m·∫∑c ƒë·ªãnh) -->
                <div id="masteryInputs" class="hidden">
                    <!-- BOSS HP -->
                    <div class="control-section">
                        <div class="section-header"><span class="label-text">M√ÅU BOSS (HP)</span></div>
                        <div class="input-row">
                            <div class="input-wrapper">
                                <input type="number" id="bossHpVal" placeholder="0" oninput="window.handleInput('bossHpVal')">
                                <select id="bossHpUnit" onchange="window.handleInput('bossHpUnit')"></select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CLICK DAMAGE -->
                    <div class="control-section">
                        <div class="section-header"><span class="label-text">S√ÅT TH∆Ø∆†NG CLICK (DAMAGE)</span></div>
                        <div class="input-row">
                            <div class="input-wrapper">
                                <input type="number" id="damageVal" placeholder="0" oninput="window.handleInput('damageVal')">
                                <select id="damageUnit" onchange="window.handleInput('damageUnit')"></select>
                            </div>
                        </div>
                    </div>

                    <!-- TIME -->
                    <div class="control-section">
                        <div class="section-header"><span class="label-text">TH·ªúI GIAN C√ÄY MASTERY</span></div>
                        <div class="time-input-group">
                            <div class="input-wrapper"><input type="number" id="timeHours" placeholder="Gi·ªù" oninput="window.handleInput('timeHours')"></div>
                            <div class="input-wrapper"><input type="number" id="timeMinutes" placeholder="Ph√∫t" oninput="window.handleInput('timeMinutes')"></div>
                            <div class="input-wrapper"><input type="number" id="timeSeconds" placeholder="Gi√¢y" oninput="window.handleInput('timeSeconds')"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. COMMON INPUT: MASTERY PER CLICK -->
                <div class="control-section" id="masteryClickInput">
                    <div class="section-header"><span class="label-text">MASTERY M·ªñI CLICK</span></div>
                    <div class="input-row">
                        <div class="input-wrapper">
                            <input type="number" id="clickVal" placeholder="0" oninput="window.handleInput('clickVal')">
                            <select id="clickUnit" onchange="window.handleInput('clickUnit')"></select>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- === C·ªòT PH·∫¢I: HI·ªÇN TH·ªä K·∫æT QU·∫¢ === -->
        <div class="right-panel">
            
            <!-- K·∫æT QU·∫¢: RANK TAB -->
            <div id="rankOutput">
                <!-- 1. BIG TIMER -->
                <div class="timer-card">
                    <div class="timer-label">TH·ªúI GIAN C√íN L·∫†I (FAST 6.7X)</div>
                    <div class="big-time" id="mainTimerDisplay">0<span class="time-unit">s</span></div>
                    <div class="sub-info">
                        Nor (5x): <span class="highlight" id="subTimerDisplay">0s</span>
                    </div>
                </div>

                <!-- 2. STATS (G·ªòP FAST & NOR) -->
                <div class="stats-grid">
                    <!-- Total Cost -->
                    <div class="stat-card" style="justify-content: center;">
                        <div class="stat-header" style="border:none; margin-bottom:5px;">
                            <div class="stat-title">T·ªîNG MASTERY C·∫¶N</div>
                            <div class="stat-icon">‚öîÔ∏è</div>
                        </div>
                        <div class="stat-value" style="font-size: 36px;" id="totalCostDisplay">0</div>
                        <div class="stat-sub">ƒê√£ tr·ª´ s·ªë ƒëang c√≥</div>
                    </div>

                    <!-- Combined Speed Card -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">T·ªêC ƒê·ªò MASTERY</div>
                            <div class="stat-icon">‚ú®</div>
                        </div>
                        
                        <!-- Fast Row -->
                        <div class="stat-row">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-fast" id="dpsDisplay">0</div>
                                <div class="stat-label-sm">Fast (6.7x)</div>
                            </div>
                        </div>
                        
                        <!-- Nor Row -->
                        <div class="stat-row" style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-nor" id="dpsNorDisplay">0</div>
                                <div class="stat-label-sm">Nor (5.0x)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- K·∫æT QU·∫¢: BOSS & MASTERY TAB -->
            <div id="masteryOutput" class="hidden">
                <!-- 1. BIG TIMER (BOSS) -->
                <div class="timer-card">
                    <div class="timer-label">TH·ªúI GIAN H·∫† BOSS (FAST 6.7X)</div>
                    <div class="big-time" id="bossTimerAuto">0<span class="time-unit">s</span></div>
                    <div class="sub-info">
                        Nor (5x): <span class="highlight" id="bossTimerNor">0s</span>
                    </div>
                </div>

                <!-- 2. STATS GRID -->
                <div class="stats-grid">
                    
                    <!-- Info Group (HP + DMG) -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">TH√îNG TIN BOSS</div>
                            <div class="stat-icon">ü©∏</div>
                        </div>
                        
                        <!-- Boss HP -->
                        <div class="stat-row">
                            <div class="stat-col-val">
                                <div class="stat-value-sm" id="bossHpDisplay">0</div>
                                <div class="stat-label-sm">M·ª•c ti√™u M√°u Boss</div>
                            </div>
                        </div>

                        <!-- Damage -->
                        <div class="stat-row" style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                            <div class="stat-col-val">
                                <div class="stat-title" style="margin-bottom: 5px; color: var(--text-secondary);">S√ÅT TH∆Ø∆†NG M·ªñI GI√ÇY</div>
                            </div>
                        </div>
                        
                        <!-- Damage Fast -->
                        <div class="stat-row">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-fast" id="damageDpsDisplay">0</div>
                                <div class="stat-label-sm">Fast (6.7x)</div>
                            </div>
                        </div>

                        <!-- Damage Nor -->
                        <div class="stat-row" style="border-top:1px dashed #333; padding-top:5px;">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-nor" id="damageDpsNorDisplay">0</div>
                                <div class="stat-label-sm">Nor (5.0x)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Mastery Gained Card -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">MASTERY ƒê·∫†T ƒê∆Ø·ª¢C</div>
                            <div class="stat-icon">üì¶</div>
                        </div>

                        <!-- Fast Row -->
                        <div class="stat-row">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-fast" id="masteryGainedDisplay">0</div>
                                <div class="stat-label-sm">Fast (6.7x)</div>
                            </div>
                        </div>

                        <!-- Nor Row -->
                        <div class="stat-row" style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-nor" id="masteryGainedNorDisplay">0</div>
                                <div class="stat-label-sm">Nor (5.0x)</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div class="footer">
        Made with love by Gemini
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId = '';
        const userSettingsPath = `artifacts/${appId}/users/`;
        const settingsDocName = 'calculator_settings';
        
        // CONFIG
        const SCALING_FACTOR = 8.400;
        const BASE_COST_MAGNITUDE = 30; 
        const K_EXPONENT = 3; 
        const CPS_AUTO = 6.7;
        const CPS_NOR = 5.0; 

        const UNITS = [
            { name: '', exp: 0 }, { name: 'K', exp: 3 }, { name: 'M', exp: 6 }, { name: 'B', exp: 9 }, { name: 'T', exp: 12 }, 
            { name: 'Qa', exp: 15 }, { name: 'Qi', exp: 18 }, { name: 'Sx', exp: 21 }, { name: 'Sp', exp: 24 }, { name: 'Oc', exp: 27 }, 
            { name: 'No', exp: 30 }, { name: 'Dc', exp: 33 }, 
            { name: 'Ud', exp: 36 }, { name: 'Dd', exp: 39 }, 
            { name: 'Td', exp: 42 }, { name: 'Qad', exp: 45 }, { name: 'Qid', exp: 48 }, { name: 'Sxd', exp: 51 }, { name: 'Spd', exp: 54 }, 
            { name: 'Ocd', exp: 57 }, { name: 'Nod', exp: 60 }, { name: 'Dec', exp: 63 }, { name: 'Und', exp: 66 }, { name: 'Duo', exp: 69 },
            { name: 'Tri', exp: 72 }, { name: 'Qua', exp: 75 }, { name: 'Qui', exp: 78 }, { name: 'Six', exp: 81 }, 
            { name: 'Sep', exp: 84 }, { name: 'Oct', exp: 87 }, { name: 'Nuo', exp: 90 }
        ];

        const RANK_COSTS = {};

        // --- UTILS ---
        function formatNumber(rawVal) {
            if (rawVal === 0) return "0";
            if (rawVal < 0) return "L·ªói";
            let unitIdx = 0;
            for (let i = UNITS.length - 1; i >= 0; i--) {
                if (rawVal >= Math.pow(10, UNITS[i].exp)) { unitIdx = i; break; }
            }
            const displayVal = rawVal / Math.pow(10, UNITS[unitIdx].exp);
            const unitName = UNITS[unitIdx].name === '' ? '' : UNITS[unitIdx].name;
            return `${displayVal.toFixed(2)}${unitName}`;
        }

        function formatBigTime(totalSeconds) {
            if (!isFinite(totalSeconds) || totalSeconds <= 0) return `0<span class="time-unit">s</span>`;
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            
            const sDisplay = totalSeconds < 60 ? totalSeconds.toFixed(2) : s;

            let html = "";
            if (h > 0) html += `${h}<span class="time-unit">h</span> `;
            if (m > 0 || h > 0) html += `${m}<span class="time-unit">m</span> `;
            html += `${sDisplay}<span class="time-unit">s</span>`;
            return html;
        }

        function formatTextTime(totalSeconds) {
            if (!isFinite(totalSeconds) || totalSeconds <= 0) return "0s";
            if (totalSeconds < 60) return totalSeconds.toFixed(2) + "s";
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return (h > 0 ? `${h}h ` : "") + `${m}m`;
        }

        function getRawVal(idVal, idUnit) {
            const val = parseFloat(document.getElementById(idVal).value) || 0;
            const unitIdx = parseInt(document.getElementById(idUnit).value) || 0;
            return val * Math.pow(10, UNITS[unitIdx].exp);
        }

        function buildRankCosts() {
            let currentCost = BASE_COST_MAGNITUDE * Math.pow(10, K_EXPONENT); 
            RANK_COSTS[0] = currentCost;
            for (let i = 1; i <= 99; i++) {
                currentCost *= SCALING_FACTOR;
                RANK_COSTS[i] = currentCost;
            }
        }

        // --- MAIN LOGIC ---
        window.handleInput = function(source) {
            const activeTab = document.getElementById('rankTabBtn').classList.contains('active') ? 'rank' : 'mastery';
            if (activeTab === 'rank') window.calculateRank();
            else window.calculateBoss();
            saveSettings();
        };

        window.syncTargetRank = function() {
            let cr = parseInt(document.getElementById('currentRank').value) || 0;
            if(cr < 0) cr = 0; if(cr > 99) cr = 99;
            document.getElementById('currentRank').value = cr;
            
            let tr = cr + 1;
            if (tr > 100) tr = 100;
            document.getElementById('targetRank').value = tr;
            
            window.calculateRank();
            saveSettings();
        };

        window.showSection = function(sectionId, shouldSave = true) {
            const isRank = sectionId === 'rank';
            document.getElementById('rankTabBtn').classList.toggle('active', isRank);
            document.getElementById('masteryTabBtn').classList.toggle('active', !isRank);
            
            document.getElementById('rankInputs').classList.toggle('hidden', !isRank);
            document.getElementById('masteryInputs').classList.toggle('hidden', isRank);
            
            document.getElementById('rankOutput').classList.toggle('hidden', !isRank);
            document.getElementById('masteryOutput').classList.toggle('hidden', isRank);
            
            if(isRank) window.calculateRank();
            else window.calculateBoss();
            
            if(shouldSave) saveSettings();
        };

        // --- CALC 1: RANK ---
        window.calculateRank = function() {
            const startRank = parseInt(document.getElementById('currentRank').value) || 0;
            const endRank = parseInt(document.getElementById('targetRank').value) || 1;
            const clickVal = getRawVal('clickVal', 'clickUnit');
            
            // L·∫•y gi√° tr·ªã Mastery ƒëang c√≥
            const currentMastery = getRawVal('currentMasteryVal', 'currentMasteryUnit');

            // document.getElementById('rankRange').innerText = `${startRank} ‚Üí ${endRank}`;

            if (startRank >= endRank) {
                document.getElementById('totalCostDisplay').innerText = "---";
                document.getElementById('mainTimerDisplay').innerHTML = "Ho√†n th√†nh";
                return;
            }

            let totalCost = 0;
            for (let i = startRank; i < endRank; i++) {
                if (RANK_COSTS[i]) totalCost += RANK_COSTS[i];
            }
            
            // Tr·ª´ ƒëi mastery ƒë√£ c√≥
            let remainingCost = totalCost - currentMastery;
            if (remainingCost < 0) remainingCost = 0;

            document.getElementById('totalCostDisplay').innerText = formatNumber(remainingCost);

            const dpsAuto = clickVal * CPS_AUTO;
            const dpsNor = clickVal * CPS_NOR;

            // C·∫≠p nh·∫≠t Fast & Nor (ƒë√£ b·ªè /s)
            document.getElementById('dpsDisplay').innerText = formatNumber(dpsAuto);
            document.getElementById('dpsNorDisplay').innerText = formatNumber(dpsNor);
            
            // T√≠nh th·ªùi gian d·ª±a tr√™n remainingCost
            const timeAuto = dpsAuto > 0 ? remainingCost / dpsAuto : 0;
            const timeNor = dpsNor > 0 ? remainingCost / dpsNor : 0;

            document.getElementById('mainTimerDisplay').innerHTML = formatBigTime(timeAuto);
            document.getElementById('subTimerDisplay').innerText = formatTextTime(timeNor);
        };

        // --- CALC 2: BOSS & MASTERY ---
        window.calculateBoss = function() {
            const bossHp = getRawVal('bossHpVal', 'bossHpUnit');
            const damage = getRawVal('damageVal', 'damageUnit'); 
            const mastery = getRawVal('clickVal', 'clickUnit'); 

            // 1. BOSS TIME
            const dpsDamageAuto = damage * CPS_AUTO;
            const dpsDamageNor = damage * CPS_NOR;
            
            const timeBossAuto = dpsDamageAuto > 0 ? bossHp / dpsDamageAuto : 0;
            const timeBossNor = dpsDamageNor > 0 ? bossHp / dpsDamageNor : 0;

            document.getElementById('bossTimerAuto').innerHTML = formatBigTime(timeBossAuto);
            document.getElementById('bossTimerNor').innerText = formatTextTime(timeBossNor);
            document.getElementById('bossHpDisplay').innerText = formatNumber(bossHp);
            
            // Update Damage DPS (Fast & Nor)
            document.getElementById('damageDpsDisplay').innerText = formatNumber(dpsDamageAuto);
            document.getElementById('damageDpsNorDisplay').innerText = formatNumber(dpsDamageNor);

            // 2. MASTERY GAINED
            const h = parseFloat(document.getElementById('timeHours').value) || 0;
            const m = parseFloat(document.getElementById('timeMinutes').value) || 0;
            const s = parseFloat(document.getElementById('timeSeconds').value) || 0;
            const totalSeconds = (h*3600) + (m*60) + s;

            const gainedAuto = mastery * CPS_AUTO * totalSeconds;
            const gainedNor = mastery * CPS_NOR * totalSeconds;
            
            document.getElementById('masteryGainedDisplay').innerText = formatNumber(gainedAuto);
            document.getElementById('masteryGainedNorDisplay').innerText = formatNumber(gainedNor);
        };

        // --- INITIALIZATION & FIREBASE ---
        function initUI() {
            buildRankCosts();
            // ƒê√£ th√™m 'currentMasteryUnit' v√†o
            const unitSelects = ['clickUnit', 'bossHpUnit', 'damageUnit', 'currentMasteryUnit'];
            unitSelects.forEach(id => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                UNITS.forEach((u, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = u.name || '';
                    if(u.name === 'K') opt.selected = true;
                    el.appendChild(opt);
                });
            });
        }

        async function saveSettings() {
            if (!userId || !db) return;
            const settings = {
                activeTab: document.getElementById('rankTabBtn').classList.contains('active') ? 'rank' : 'mastery',
                
                currentMasteryVal: document.getElementById('currentMasteryVal').value,
                currentMasteryUnit: document.getElementById('currentMasteryUnit').value,
                
                clickVal: document.getElementById('clickVal').value,
                clickUnit: document.getElementById('clickUnit').value,
                damageVal: document.getElementById('damageVal').value,
                damageUnit: document.getElementById('damageUnit').value,
                currentRank: document.getElementById('currentRank').value,
                targetRank: document.getElementById('targetRank').value,
                bossHpVal: document.getElementById('bossHpVal').value,
                bossHpUnit: document.getElementById('bossHpUnit').value,
                timeHours: document.getElementById('timeHours').value,
                timeMinutes: document.getElementById('timeMinutes').value,
                timeSeconds: document.getElementById('timeSeconds').value,
            };
            try { await setDoc(doc(db, userSettingsPath, userId, 'app_data', settingsDocName), settings); } 
            catch (e) { console.error(e); }
        }

        async function loadSettings() {
            if (!userId || !db) return;
            try {
                const snap = await getDoc(doc(db, userSettingsPath, userId, 'app_data', settingsDocName));
                if (snap.exists()) {
                    const s = snap.data();
                    
                    document.getElementById('currentMasteryVal').value = s.currentMasteryVal || '0';
                    document.getElementById('currentMasteryUnit').value = s.currentMasteryUnit || '1';
                    
                    document.getElementById('clickVal').value = s.clickVal || '0';
                    document.getElementById('clickUnit').value = s.clickUnit || '1';
                    document.getElementById('damageVal').value = s.damageVal || '0';
                    document.getElementById('damageUnit').value = s.damageUnit || '1';
                    document.getElementById('currentRank').value = s.currentRank || '0';
                    document.getElementById('targetRank').value = s.targetRank || '1';
                    document.getElementById('bossHpVal').value = s.bossHpVal || '0';
                    document.getElementById('bossHpUnit').value = s.bossHpUnit || '1';
                    document.getElementById('timeHours').value = s.timeHours || '0';
                    document.getElementById('timeMinutes').value = s.timeMinutes || '0';
                    document.getElementById('timeSeconds').value = s.timeSeconds || '0';
                    
                    const tab = s.activeTab || 'rank';
                    setTimeout(() => { window.showSection(tab, false); }, 50);
                } else { window.handleInput(); }
            } catch (e) { window.handleInput(); }
        }

        async function setupFirebase() {
            if (!firebaseConfig?.apiKey) return;
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch { await signInAnonymously(auth); }
            onAuthStateChanged(auth, (u) => { if(u) { userId = u.uid; loadSettings(); } });
        }

        // Expose key functions to window for HTML event handlers
        window.handleInput = handleInput;
        window.syncTargetRank = syncTargetRank;
        window.showSection = showSection;
        window.calculateRank = calculateRank;
        window.calculateBoss = calculateBoss;

        window.onload = () => { initUI(); setupFirebase(); };
    </script>
</body>
</html>
