<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AW.Calc - Mastery & Damage</title>
    <!-- ƒê·ªïi Favicon th√†nh file ·∫£nh c·ªßa b·∫°n -->
    <link rel="icon" href="favicon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #050505;
            --bg-card: #0f0f0f;
            --bg-input: #000000;
            --border-color: #222;
            --accent-primary: #2962ff; /* Xanh d∆∞∆°ng ƒë·∫≠m */
            --accent-glow: rgba(41, 98, 255, 0.4);
            --accent-text: #448aff;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --text-value: #e0e0e0;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
            --bg-update-item: #151515;
            --bg-update-active: #2962ff;
            
            /* --- M√ÄU RI√äNG CHO T·ª™NG TAB --- */
            --col-rank: #2962ff;      /* Rank: Xanh d∆∞∆°ng */
            --col-mastery: #ff5722;   /* Mastery: Cam ƒë·ªè */
            --col-gacha: #d500f9;     /* Gacha: T√≠m */
            --col-raid: #ffeb3b;      /* Raid: V√†ng */
            --col-update: #00e676;    /* Update: Xanh l√° */
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-sans);
            margin: 0;
            padding: 20px; 
            display: flex;
            flex-direction: column; 
            align-items: center;    
            min-height: 100vh;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* --- LAYOUT M·ªöI: FLEX COLUMN --- */
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 1200px;
            width: 100%;
            flex: 1; 
        }

        /* --- HEADER (CENTERED WITH ICON - FINAL STYLE) --- */
        .brand-header { 
            display: flex;
            flex-direction: column; /* X·∫øp d·ªçc */
            align-items: center;    /* CƒÉn gi·ªØa */
            text-align: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .brand-logo {
            width: 80px; 
            height: 80px;
            object-fit: cover;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(41, 98, 255, 0.15);
            border: 1px solid #333;
            transition: transform 0.3s ease;
            margin-bottom: 5px;
        }

        .brand-logo:hover { transform: scale(1.05) rotate(2deg); }
        
        .brand-title {
            font-family: var(--font-sans); 
            font-size: 28px; 
            font-weight: 800;
            color: #fff;
            margin: 0;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.5px;
        }
        
        .title-icon { font-size: 24px; opacity: 0.8; margin-right: 2px; }
        .brand-title span { color: var(--accent-primary); } 
        
        .brand-subtitle {
            font-size: 14px; /* TƒÉng size ch·ªØ l√™n x√≠u */
            color: var(--text-secondary);
            font-weight: 600; /* ƒê·∫≠m h∆°n */
            font-family: var(--font-sans);
        }

        /* --- NAV BAR (N·∫∞M NGANG ·ªû TR√äN) --- */
        .nav-tabs-container {
            background: #0a0a0a; 
            padding: 8px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative; 
            z-index: 10;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: #555; 
            padding: 14px;
            font-family: var(--font-sans);
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            white-space: nowrap;
            letter-spacing: 1px;
        }

        .nav-btn:hover { 
            color: #fff; 
            background-color: rgba(255,255,255,0.03);
        }

        /* Active States v·ªõi m√†u ri√™ng bi·ªát */
        #rankTabBtn.active { background-color: var(--col-rank); color: #fff; box-shadow: 0 4px 15px rgba(41, 98, 255, 0.3); }
        #masteryTabBtn.active { background-color: var(--col-mastery); color: #fff; box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3); }
        #gachaTabBtn.active { background-color: var(--col-gacha); color: #fff; box-shadow: 0 4px 15px rgba(213, 0, 249, 0.3); }
        #raidTabBtn.active { background-color: var(--col-raid); color: #000; box-shadow: 0 4px 15px rgba(255, 235, 59, 0.3); }
        #updateTabBtn.active { background-color: var(--col-update); color: #000; box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3); }

        /* --- CONTENT GRID (CH·ª®A 2 C·ªòT D∆Ø·ªöI) --- */
        .content-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
            width: 100%;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- COMMON CARD STYLES --- */
        .card-glow {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            position: relative;
        }

        .card-glow::before {
            content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1.5px;
            background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), var(--accent-glow), transparent 40%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
            z-index: 2; pointer-events: none; opacity: 0; transition: opacity 0.3s ease;
        }
        .card-glow:hover::before { opacity: 1; }
        
        .control-card {
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1; 
        }

        /* Inputs Styling */
        .control-section { margin-bottom: 20px; }
        .control-section:last-child { margin-bottom: 0; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .label-text { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;}
        .label-text::before { content:''; width: 4px; height: 4px; background: var(--accent-text); display: inline-block; border-radius: 50%; }

        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-wrapper {
            background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 10px;
            padding: 0 12px; height: 48px; display: flex; align-items: center; width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-wrapper:focus-within { border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-glow); }

        input, select { background: transparent; border: none; color: #fff; font-family: var(--font-mono); font-size: 15px; width: 100%; height: 100%; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        select { color: var(--accent-text); font-weight: 700; text-align: right; cursor: pointer; min-width: 60px; }
        select option { background-color: #000; color: #fff; }

        .time-input-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

        .spin-mode-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .spin-btn {
            background: var(--bg-input); border: 1px solid var(--border-color); color: #666; padding: 12px;
            border-radius: 10px; font-family: var(--font-mono); font-weight: 700; cursor: pointer; transition: all 0.2s;
        }
        .spin-btn:hover { color: #fff; border-color: #444; }
        .spin-btn.active {
            background: rgba(213, 0, 249, 0.1); border-color: var(--col-gacha); color: var(--col-gacha);
            box-shadow: 0 0 15px rgba(213, 0, 249, 0.1);
        }

        /* Version List & Raid List */
        .version-list, .raid-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .version-list::-webkit-scrollbar, .raid-list::-webkit-scrollbar { width: 4px; }
        .version-list::-webkit-scrollbar-thumb, .raid-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        
        .version-item { padding: 15px; cursor: pointer; transition: transform 0.2s ease; z-index: 1; border-radius: 12px; border: 1px solid var(--border-color); background: #111; }
        .version-item:hover { transform: translateX(2px); border-color: #444; }
        .version-item.active { border-color: var(--col-update); background: linear-gradient(90deg, rgba(0, 230, 118, 0.05) 0%, rgba(0,0,0,0) 100%); }
        .v-title { font-weight: 700; font-size: 14px; color: #fff; margin-bottom: 4px; }
        .v-date { font-size: 11px; color: var(--text-secondary); font-family: var(--font-mono); }

        /* Raid Table Styles */
        .raid-table-container {
            height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; background: #0a0a0a; overflow-x: auto;
        }
        .raid-table { width: 100%; border-collapse: collapse; min-width: 500px; /* ƒê·∫£m b·∫£o b·∫£ng kh√¥ng b·ªã co qu√° nh·ªè */ }
        .raid-table th { 
            position: sticky; top: 0; background: #151515; color: var(--col-raid); 
            padding: 12px; font-size: 12px; text-align: right; z-index: 2; 
            border-bottom: 1px solid #333; white-space: nowrap;
        }
        .raid-table th:first-child { text-align: left; }
        .raid-table td { 
            padding: 10px 12px; border-bottom: 1px solid #222; 
            font-family: var(--font-mono); font-size: 13px; color: #ddd; text-align: right;
        }
        .raid-table td:first-child { text-align: left; color: var(--col-raid); font-weight: 700; }
        .raid-table tr:hover { background: rgba(255, 235, 59, 0.05); }
        .raid-hl { color: var(--col-raid); font-weight: bold; }
        .val-fast { color: var(--accent-text); }
        .val-nor { color: #888; }

        /* Timer Card */
        .timer-card {
            padding: 40px; text-align: center; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            min-height: 220px; --accent-glow: rgba(41, 98, 255, 0.8); 
        }
        .timer-label { font-size: 12px; letter-spacing: 2px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 16px; font-weight: 700; }
        .big-time { font-family: var(--font-mono); font-size: 64px; font-weight: 700; color: #fff; text-shadow: 0 0 30px rgba(41, 98, 255, 0.3); line-height: 1; margin-bottom: 16px; }
        .time-unit { font-size: 0.5em; color: var(--text-secondary); font-weight: 400; margin-right: 6px;}
        .sub-info { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; }
        .highlight { color: var(--accent-text); font-weight: bold; margin-left: 5px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .stat-card { padding: 24px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .stat-title { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-icon { font-size: 18px; opacity: 0.7; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stat-row:last-child { margin-bottom: 0; }
        .stat-value-sm { font-family: var(--font-mono); font-size: 20px; font-weight: 700; color: #fff; }
        .stat-label-sm { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .accent-fast { color: var(--accent-text); }
        .accent-nor { color: #888; }
        .stat-value { font-family: var(--font-mono); font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 8px; line-height: 1; }
        .stat-sub { font-size: 12px; color: var(--text-secondary); }

        /* Update Details */
        .update-card { padding: 0; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-height: 400px; display: flex; flex-direction: column; }
        .update-header-box { background: #111; padding: 24px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .up-title { font-family: var(--font-mono); font-size: 22px; font-weight: 800; color: #fff; }
        .up-date { font-family: var(--font-mono); font-size: 13px; color: var(--col-update); background: rgba(0, 230, 118, 0.1); padding: 6px 12px; border-radius: 8px; font-weight: 700;}
        .update-content { padding: 30px; font-size: 14px; line-height: 1.8; color: #ddd; flex: 1; }
        .update-list-ul { list-style: none; padding: 0; margin: 0; }
        .update-list-ul li { position: relative; padding-left: 20px; margin-bottom: 8px; }
        .update-list-ul li::before { content: '-'; position: absolute; left: 0; color: var(--col-update); font-weight: bold; }

        .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #444; font-family: var(--font-mono); }

        @media (max-width: 850px) {
            .content-grid { grid-template-columns: 1fr; }
            .nav-tabs { grid-template-columns: 1fr 1fr; }
            .brand-header { justify-content: center; }
            .big-time { font-size: 48px; }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- 1. HEADER -->
        <div class="brand-header">
            <img src="favicon.png" alt="Logo" class="brand-logo">
            <h1 class="brand-title">
                <span class="title-icon">‚öîÔ∏è</span> 
                Anime Weapons 
                <span>Calc</span>
            </h1>
            <div class="brand-subtitle">C√¥ng c·ª• t√≠nh to√°n m·ªçi th·ª© c√≥ trong Anime Weapons</div>
        </div>

        <!-- 2. NAV BAR -->
        <div class="nav-tabs-container card-glow">
            <div class="nav-tabs">
                <button class="nav-btn active" id="rankTabBtn" onclick="window.showSection('rank')">Rank</button>
                <button class="nav-btn" id="masteryTabBtn" onclick="window.showSection('mastery')">Boss/Mastery</button>
                <button class="nav-btn" id="gachaTabBtn" onclick="window.showSection('gacha')">Gacha</button>
                <button class="nav-btn" id="raidTabBtn" onclick="window.showSection('raid')">Raid</button>
                <button class="nav-btn" id="updateTabBtn" onclick="window.showSection('updates')">C·∫≠p nh·∫≠t</button>
            </div>
        </div>

        <!-- 3. CONTENT GRID -->
        <div class="content-grid">
            
            <!-- === C·ªòT TR√ÅI: NH·∫¨P LI·ªÜU === -->
            <div class="left-panel">
                <div class="control-card card-glow">
                    
                    <!-- RANK INPUTS -->
                    <div id="rankInputs">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">RANK HI·ªÜN T·∫†I</span></div>
                            <div class="input-wrapper">
                                <input type="number" id="currentRank" min="0" max="100" value="0" oninput="window.syncTargetRank()">
                            </div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">RANK M·ª§C TI√äU</span></div>
                            <div class="input-wrapper">
                                <input type="number" id="targetRank" min="1" max="100" value="1" oninput="window.calculate(); window.handleInput()">
                            </div>
                        </div>
                        <!-- COMMON INPUTS FOR RANK -->
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">MASTERY M·ªñI CLICK</span></div>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="clickVal" placeholder="0" oninput="window.handleInput('clickVal')">
                                    <select id="clickUnit" onchange="window.handleInput('clickUnit')"></select>
                                </div>
                            </div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">MASTERY ƒêANG C√ì</span></div>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="currentMasteryVal" placeholder="0" oninput="window.handleInput('currentMasteryVal')">
                                    <select id="currentMasteryUnit" onchange="window.handleInput('currentMasteryUnit')"></select>
                                </div>
                            </div>
                        </div>
                        <!-- RANK NOTE (LARGER FONT) -->
                        <div style="font-size:13px; color:#aaa; margin-top:15px; font-style:italic; text-align:center; line-height:1.5; font-weight:600;">
                            *Ch·ªâ l√† x·∫•p s·ªâ c√≥ th·ªÉ sai s·ªë.<br>M·ªói rank s·∫Ω c√°ch nhau 8.4 l·∫ßn.
                        </div>
                    </div>

                    <!-- MASTERY INPUTS -->
                    <div id="masteryInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">M√ÅU BOSS (HP)</span></div>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="bossHpVal" placeholder="0" oninput="window.handleInput('bossHpVal')">
                                    <select id="bossHpUnit" onchange="window.handleInput('bossHpUnit')"></select>
                                </div>
                            </div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">S√ÅT TH∆Ø∆†NG CLICK</span></div>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="damageVal" placeholder="0" oninput="window.handleInput('damageVal')">
                                    <select id="damageUnit" onchange="window.handleInput('damageUnit')"></select>
                                </div>
                            </div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">TH·ªúI GIAN C√ÄY</span></div>
                            <div class="time-input-group">
                                <div class="input-wrapper"><input type="number" id="timeHours" placeholder="Gi·ªù" oninput="window.handleInput('timeHours')"></div>
                                <div class="input-wrapper"><input type="number" id="timeMinutes" placeholder="Ph√∫t" oninput="window.handleInput('timeMinutes')"></div>
                                <div class="input-wrapper"><input type="number" id="timeSeconds" placeholder="Gi√¢y" oninput="window.handleInput('timeSeconds')"></div>
                            </div>
                        </div>
                        <!-- COMMON DUPLICATE -->
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">MASTERY M·ªñI CLICK</span></div>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="clickValDup" placeholder="0" oninput="window.syncClickVal(this.value)">
                                    <select id="clickUnitDup" onchange="window.syncClickUnit(this.value)"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GACHA INPUTS (SIMPLIFIED) -->
                    <div id="gachaInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">T·ªîNG SHARDS (M·∫¢NH)</span></div>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="gachaShardsVal" placeholder="0" oninput="window.calculateGacha()">
                                    <select id="gachaShardsUnit" onchange="window.calculateGacha()"></select>
                                </div>
                            </div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">CH·∫æ ƒê·ªò QUAY</span></div>
                            <div class="spin-mode-group">
                                <button class="spin-btn active" id="spin1x" onclick="window.setSpinMode(1)">1x Spin</button>
                                <button class="spin-btn" id="spin2x" onclick="window.setSpinMode(2)">2x Spin</button>
                            </div>
                            <div style="font-size:11px; color:#666; text-align:center; margin-top:5px;">C∆° b·∫£n: 1.5s / l∆∞·ª£t</div>
                        </div>
                        <!-- ROOM 60S REMOVED COMPLETELY -->
                    </div>

                    <!-- RAID INPUTS -->
                    <div id="raidInputs" class="hidden">
                        <!-- CALCULATE SPECIFIC STAGE -->
                        <div class="control-section">
                            <div class="section-header"><span class="label-text" style="color:var(--col-raid);">T√çNH TO√ÅN ·∫¢I C·ª§ TH·ªÇ</span></div>
                            <div class="section-header"><span class="label-text">S·ªê ·∫¢I MU·ªêN CH·ªåN</span></div>
                            <div class="input-wrapper">
                                <input type="number" id="raidTargetStageInput" placeholder="Nh·∫≠p s·ªë ·∫£i (V√≠ d·ª•: 180)" oninput="window.calculateRaidTarget()">
                            </div>
                             <!-- UPDATED NOTE -->
                             <div style="font-size:13px; color:#aaa; margin-top:8px; font-style:italic; font-weight:600; text-align:center;">
                                 *HP boss ch·ªâ l√† x·∫•p s·ªâ th√¥i nh√©.<br>M·ªói 5 ·∫£i m√°u boss s·∫Ω tƒÉng 10.4 l·∫ßn ƒëi solo.
                             </div>
                        </div>

                        <!-- RAID CONFIG (HIDDEN) -->
                        <div class="control-section" style="display:none;"> 
                            <div class="section-header"><span class="label-text">C·∫§U H√åNH C∆† B·∫¢N</span></div>
                            
                            <div class="section-header"><span class="label-text" style="font-size:10px; color:#666;">M·ªêC THAM CHI·∫æU (REF)</span></div>
                            <div class="input-wrapper" style="margin-bottom:10px;">
                                <input type="number" id="raidRefStage" placeholder="V√≠ d·ª•: 100" value="100" oninput="window.calculateRaid()">
                            </div>

                            <div class="section-header"><span class="label-text" style="font-size:10px; color:#666;">HP THAM CHI·∫æU</span></div>
                            <div class="input-row" style="margin-bottom:10px;">
                                <div class="input-wrapper">
                                    <input type="number" id="raidRefHpVal" placeholder="4" value="4" oninput="window.calculateRaid()">
                                    <select id="raidRefHpUnit" onchange="window.calculateRaid()"></select>
                                </div>
                            </div>

                            <div class="section-header"><span class="label-text" style="font-size:10px; color:#666;">TƒÇNG TR∆Ø·ªûNG (M·ªñI 5 ·∫¢I)</span></div>
                            <div class="input-wrapper">
                                <input type="number" id="raidGrowth" placeholder="10.4" value="10.4" oninput="window.calculateRaid()">
                            </div>
                        </div>
                    </div>

                    <!-- UPDATE LIST -->
                    <div id="updateInputs" class="hidden">
                        <div class="section-header"><span class="label-text">PHI√äN B·∫¢N</span></div>
                        <div class="version-list" id="versionListContainer">
                            <!-- JS Injects here -->
                        </div>
                    </div>

                </div>
            </div>

            <!-- === C·ªòT PH·∫¢I: K·∫æT QU·∫¢ === -->
            <div class="right-panel">
                
                <!-- RANK RESULTS -->
                <div id="rankOutput">
                    <div class="timer-card card-glow">
                        <div class="timer-label">TH·ªúI GIAN C√íN L·∫†I (FAST 6.7X)</div>
                        <div class="big-time" id="mainTimerDisplay">0<span class="time-unit">s</span></div>
                        <div class="sub-info">Nor (5x): <span class="highlight" id="subTimerDisplay">0s</span></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card card-glow" style="justify-content:center;">
                            <div class="stat-header" style="border:none; margin-bottom:5px;"><div class="stat-title">T·ªîNG MASTERY C·∫¶N</div></div>
                            <div class="stat-value" id="totalCostDisplay">0</div>
                            <div class="stat-sub">ƒê√£ tr·ª´ s·ªë ƒëang c√≥</div>
                        </div>
                        <div class="stat-card card-glow">
                            <div class="stat-header"><div class="stat-title">T·ªêC ƒê·ªò C√ÄY</div><div class="stat-icon">‚ö°</div></div>
                            <div class="stat-row"><div class="stat-col-val"><div class="stat-value-sm accent-fast" id="dpsDisplay">0</div><div class="stat-label-sm">Fast (6.7x)</div></div></div>
                            <div class="stat-row" style="border-top:1px dashed #333; padding-top:10px;"><div class="stat-col-val"><div class="stat-value-sm accent-nor" id="dpsNorDisplay">0</div><div class="stat-label-sm">Nor (5.0x)</div></div></div>
                        </div>
                    </div>
                </div>

                <!-- MASTERY RESULTS -->
                <div id="masteryOutput" class="hidden">
                    <div class="timer-card card-glow">
                        <div class="timer-label">TH·ªúI GIAN H·∫† BOSS (FAST 6.7X)</div>
                        <div class="big-time" id="bossTimerAuto">0<span class="time-unit">s</span></div>
                        <div class="sub-info">Nor (5x): <span class="highlight" id="bossTimerNor">0s</span></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card card-glow">
                            <div class="stat-header"><div class="stat-title">TH√îNG TIN BOSS</div><div class="stat-icon">ü©∏</div></div>
                            <div class="stat-row"><div class="stat-col-val"><div class="stat-value-sm" id="bossHpDisplay">0</div><div class="stat-label-sm">M√°u Boss</div></div></div>
                            <div class="stat-row" style="border-top:1px dashed #333; padding-top:10px; margin-top:10px;"><div class="stat-col-val"><div class="stat-value-sm accent-fast" id="damageDpsDisplay">0</div><div class="stat-label-sm">DPS Fast (6.7x)</div></div></div>
                        </div>
                        <div class="stat-card card-glow">
                            <div class="stat-header"><div class="stat-title">MASTERY ƒê·∫†T ƒê∆Ø·ª¢C</div><div class="stat-icon">üì¶</div></div>
                            <div class="stat-row"><div class="stat-col-val"><div class="stat-value-sm accent-fast" id="masteryGainedDisplay">0</div><div class="stat-label-sm">Fast (6.7x)</div></div></div>
                            <div class="stat-row" style="border-top:1px dashed #333; padding-top:10px; margin-top:10px;"><div class="stat-col-val"><div class="stat-value-sm accent-nor" id="masteryGainedNorDisplay">0</div><div class="stat-label-sm">Nor (5.0x)</div></div></div>
                        </div>
                    </div>
                </div>

                <!-- GACHA RESULTS (SIMPLIFIED) -->
                <div id="gachaOutput" class="hidden">
                    <div class="timer-card card-glow" style="--accent-glow: rgba(213, 0, 249, 0.6);">
                        <div class="timer-label">TH·ªúI GIAN D·ª∞ KI·∫æN</div>
                        <div class="big-time" id="gachaTimerDisplay">0<span class="time-unit">s</span></div>
                        <div class="sub-info">M·ªü <span class="highlight" id="gachaItemsDisplay">0</span> v·∫≠t ph·∫©m</div>
                    </div>
                    <!-- Removed Stat Grid (Total Rolls, Cycles, Room 60s) -->
                </div>

                <!-- RAID RESULTS -->
                <div id="raidOutput" class="hidden">
                    
                    <!-- 1. TARGET RAID CARD -->
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-raid);">
                        <div class="stat-header">
                            <div class="stat-title">K·∫æT QU·∫¢ T√çNH TO√ÅN ·∫¢I <span id="raidTargetStageDisplay" style="color:#fff;">---</span></div>
                            <div class="stat-icon">üéØ</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-col-val">
                                <div class="stat-value" id="raidTargetHpDisplay">0</div>
                                <div class="stat-label-sm">M√°u Boss D·ª± Ki·∫øn</div>
                            </div>
                        </div>

                        <!-- UPDATED: ROW 1 - CLICK FAST & NOR -->
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val">
                                <div class="stat-value-sm accent-fast" id="raidTargetClickFast">0</div>
                                <div class="stat-label-sm">1 Click (Fast 6.7x)</div>
                            </div>
                            <div class="stat-col-val" style="text-align:right;">
                                <div class="stat-value-sm accent-nor" id="raidTargetClickNor">0</div>
                                <div class="stat-label-sm">1 Click (Nor 5.0x)</div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. RAID TABLE -->
                    <div class="update-card card-glow">
                        <div class="update-header-box">
                            <div class="up-title" style="color:var(--col-raid);">B·∫£ng tra c·ª©u Raid Boss</div>
                            <div class="up-date" style="background:rgba(255,235,59,0.1); color:var(--col-raid);">100+</div>
                        </div>
                        <div class="raid-table-container">
                            <table class="raid-table" id="raidTableBody">
                                <!-- JS Injects rows here -->
                            </table>
                        </div>
                    </div>
                </div>

                <!-- UPDATE LOGS RESULTS -->
                <div id="updateOutput" class="hidden">
                    <div class="update-card card-glow">
                        <div class="update-header-box">
                            <div class="up-title" id="displayUpTitle">Title</div>
                            <div class="up-date" id="displayUpDate">Date</div>
                        </div>
                        <div class="update-content" id="displayUpContent">Content</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="footer">
        Made with love by Gemini
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId = '';
        const userSettingsPath = `artifacts/${appId}/users/`;
        const settingsDocName = 'calculator_settings';
        let spinMode = 1; 
        
        // --- DATA UPDATE LOGS ---
        const UPDATE_DATA = [
            {
                id: 'update_1_pt2',
                title: 'Update 1 Pt.2',
                date: '21/11/2025',
                content: `
                    <strong>Ch·∫ø ƒë·ªô ch∆°i m·ªõi: Ph√≤ng th·ªß!</strong>
                    <ul class="update-list-ul">
                        <li>ƒê√°nh b·∫°i c√°c ƒë·ª£t k·∫ª th√π ƒëang c·ªë g·∫Øng ph√° h·ªßy l√¢u ƒë√†i c·ªßa b·∫°n!</li>
                        <li>Ho√†n th√†nh m·ªói ƒë·ª£t, b·∫°n c√≥ c∆° h·ªôi nh·∫≠n ƒë∆∞·ª£c S·ª©c m·∫°nh Ph√≤ng th·ªß!</li>
                        <li>ƒê√£ th√™m Th√†nh t·ª±u cho ch·∫ø ƒë·ªô Ph√≤ng th·ªß!</li>
                    </ul>
                    <strong>Giao d·ªãch M·∫£nh (Shard Trade)</strong>
                    <ul class="update-list-ul">
                        <li>H√£y t·∫≠n d·ª•ng Token d∆∞ th·ª´a! ƒê·ªïi ch√∫ng v·ªõi t·ª∑ l·ªá 10:1 t·∫°i L√†ng Shinobi!</li>
                    </ul>
                    <strong>B·ªï sung:</strong>
                    <ul class="update-list-ul">
                        <li>Huy·∫øt Qu·ª∑ Thu·∫≠t (Demon Arts) k√®m n√¢ng c·∫•p!</li>
                        <li>G√≥i Gi·ªõi h·∫°n M·ªõi!</li>
                    </ul>
                    <strong>C·∫£i thi·ªán tr·∫£i nghi·ªám (QOL):</strong>
                    <ul class="update-list-ul">
                        <li>S·ª©c m·∫°nh Raid gi·ªù r·ªõt m·ªói ƒë·ª£t; tr∆∞·ªõc ƒë√¢y l√† m·ªói 5 ƒë·ª£t;</li>
                        <li>Th√™m ch·ªâ s·ªë c·∫•p ƒë·ªô v√† s·ª©c m·∫°nh v√†o popup v·∫≠t ph·∫©m gacha ƒë√£ n√¢ng c·∫•p;</li>
                        <li>Th√™m g·ª£i √Ω t∆∞∆°ng t√°c: Y√™u th√≠ch v√† theo d√µi s·ª± ki·ªán m√† kh√¥ng c·∫ßn tho√°t game;</li>
                        <li>C·∫£i thi·ªán m·ªôt s·ªë giao di·ªán;</li>
                    </ul>
                    <strong>S·ª≠a l·ªói:</strong>
                    <ul class="update-list-ul">
                        <li>G·ª° Avatar kh√¥ng tr·∫£ nh√¢n v·∫≠t v·ªÅ tr·∫°ng th√°i g·ªëc;</li>
                        <li>Th√∫ c∆∞ng trang b·ªã qu√° gi·ªõi h·∫°n gi·ªù s·∫Ω t·ª± ƒë·ªông g·ª° b·ªè;</li>
                        <li>Kh·∫Øc ph·ª•c l·ªói hi·ªÉn th·ªã ng∆∞·ªùi ch∆°i b·ªã k·∫πt tr√™n kh√¥ng (ƒë·ªëi v·ªõi ng∆∞·ªùi kh√°c);</li>
                        <li>Thu·ªëc kh√¥ng hi·ªÉn th·ªã ch·ªâ s·ªë c·ªông th√™m trong t√∫i ƒë·ªì;</li>
                    </ul>
                    <br>
                    <div style="font-weight:bold; color:var(--col-update);">M·ªåI THAY ƒê·ªîI C√ì S·∫¥N TRONG PHI√äN B·∫¢N 10500 HO·∫∂C CAO H∆†N</div>
                `
            },
            {
                id: 'update_1',
                title: 'Update 1',
                date: '21/11/2025',
                content: `
                    <strong>Khu v·ª±c m·ªõi: Paradis</strong>
                    <ul class="update-list-ul">
                        <li>V≈© kh√≠ m·ªõi (+6)</li>
                        <li>Avatar m·ªõi (+6)</li>
                        <li>Sao m·ªõi (+7)</li>
                        <li>Ph·ª• ki·ªán m·ªõi (+4)</li>
                    </ul>
                    <strong>Thay ƒë·ªïi c∆° ch·∫ø Ng·ªçc l·ª•c b·∫£o (Emeralds) t·ª´ Code:</strong>
                    <ul class="update-list-ul">
                        <li>Kh√¥ng th·ªÉ d√πng ƒë·ªÉ t·∫∑ng qu√†; c√≥ ch·ªâ b√°o ƒë·ªè hi·ªÉn th·ªã s·ªë l∆∞·ª£ng kh√¥ng th·ªÉ t·∫∑ng.</li>
                    </ul>
                    <strong>Gacha m·ªõi:</strong>
                    <ul class="update-list-ul">
                        <li>Titans Gacha</li>
                        <li>Gacha T·ªï ch·ª©c (Organizations)</li>
                    </ul>
                    <strong>M·ªõi:</strong>
                    <ul class="update-list-ul">
                        <li>H√†o quang (Aura) m·ªõi</li>
                        <li>Danh hi·ªáu: Th·ª£ sƒÉn Titan (Titan Hunter)</li>
                    </ul>
                    <strong>M·ªü r·ªông gi·ªõi h·∫°n:</strong>
                    <ul class="update-list-ul">
                        <li>C·∫•p ƒë·ªô ng∆∞·ªùi ch∆°i: 120 ‚Üí 140</li>
                        <li>Rank Up: +3 c·∫•p</li>
                        <li>N√¢ng c·∫•p Y√™n: S√°t th∆∞∆°ng (+5), Mastery (+5), Ch√≠ m·∫°ng (+5), Y√™n (+2).</li>
                        <li>N√¢ng c·∫•p Token: S√°t th∆∞∆°ng (+5), Mastery (+5).</li>
                    </ul>
                    <strong>C·∫£i thi·ªán tr·∫£i nghi·ªám (QOL):</strong>
                    <ul class="update-list-ul">
                        <li>Tab ƒê·ªôc quy·ªÅn trong M·ª•c l·ª•c (Index).</li>
                        <li>N√∫t trang b·ªã skin ch·ªâ hi·ªán cho v≈© kh√≠ ƒë√£ c√≥.</li>
                        <li>T·ªëi ∆∞u h√≥a t·∫£i khu v·ª±c qu√°i v·∫≠t g·∫ßn.</li>
                        <li>Th√¥ng b√°o chi ti·∫øt h∆°n.</li>
                        <li>L√†m l·∫°i m·ªôt s·ªë ho·∫°t ·∫£nh v≈© kh√≠.</li>
                    </ul>
                    <strong>S·ª≠a l·ªói:</strong>
                    <ul class="update-list-ul">
                        <li>Ph·∫ßn th∆∞·ªüng Gacha kh√¥ng cƒÉn gi·ªØa ch√≠nh x√°c.</li>
                        <li>L·ªói kh√¥ng nh·∫≠n ƒë∆∞·ª£c qu√† tu·∫ßn ng√†y 7.</li>
                    </ul>
                `
            },
            {
                id: 'patch_21_11',
                title: 'Patch Update',
                date: '21/11/2025',
                content: `
                    <strong>S·ª≠a l·ªói v√† ƒêi·ªÅu ch·ªânh:</strong>
                    <ul class="update-list-ul">
                        <li>S·ª≠a v√† ƒëi·ªÅu ch·ªânh t·ª∑ l·ªá Gacha ch√≠nh x√°c h∆°n.</li>
                        <li>TƒÉng s·ª©c m·∫°nh (Buff) cho Ki·∫øm ƒê·ªôc quy·ªÅn (Exclusive Sword).</li>
                        <li>S·ª≠a l·∫°i ho·∫°t ·∫£nh ng∆∞·ªùi ch∆°i.</li>
                        <li>TƒÉng ch·ªâ s·ªë c·ªông th√™m c·ªßa M·∫Øt Ma Thu·∫≠t khi n√¢ng c·∫•p.</li>
                        <li>S·ª≠a nhi·ªÅu l·ªói nh·ªè ƒë·ªÉ c·∫£i thi·ªán ƒë·ªô ·ªïn ƒë·ªãnh c·ªßa game.</li>
                    </ul>
                `
            },
            {
                id: 'release_pt3',
                title: 'Release Pt.3',
                date: '19/11/2025',
                content: `
                    <strong>Gacha M·ªõi & T√≠nh nƒÉng:</strong>
                    <ul class="update-list-ul">
                        <li><strong>Gacha M·∫Øt Ma Thu·∫≠t (Magic Eyes):</strong> B·∫°n c√≥ th·ªÉ ti·∫øn h√≥a ch√∫ng!</li>
                        <li><strong>VIP:</strong> Gi·∫£m gi√° 20% khi quay Gacha!</li>
                        <li><strong>G√≥i ƒê·ªôc quy·ªÅn:</strong> Avatar & V≈© kh√≠ m·ªõi! T·∫∑ng th√™m +1 Danh hi·ªáu.</li>
                    </ul>
                    <strong>M·ªü r·ªông Gi·ªõi h·∫°n:</strong>
                    <ul class="update-list-ul">
                        <li>+20 C·∫•p ƒë·ªô Ng∆∞·ªùi ch∆°i (100 ‚Üí 120).</li>
                        <li>+5 N√¢ng c·∫•p Y√™n (Yen Upgrades).</li>
                        <li>+5 Th√†nh t·ª±u Mastery.</li>
                        <li>+5 Th√†nh t·ª±u S√°t th∆∞∆°ng.</li>
                        <li>+3 C·∫•p Rank m·ªõi.</li>
                    </ul>
                    <strong>C·∫£i thi·ªán tr·∫£i nghi·ªám (QOL):</strong>
                    <ul class="update-list-ul">
                        <li>C·∫≠p nh·∫≠t & c·∫£i thi·ªán Danh s√°ch ph√°t nh·∫°c.</li>
                        <li>Trang b·ªã skin v≈© kh√≠ theo s·ªë th·ª© t·ª± (index).</li>
                        <li>C·∫£i thi·ªán hi·ªÉn th·ªã DPS v√† c√°c ch·ªâ s·ªë ph·∫ßn trƒÉm.</li>
                        <li>C·∫£i thi·ªán M√†n h√¨nh D·ªãch chuy·ªÉn.</li>
                        <li>T√≠nh nƒÉng "Trang b·ªã T·ªët nh·∫•t" gi·ªù s·∫Ω d√πng thu·ªôc t√≠nh ƒë√£ ch·ªçn trong T√∫i S·ª©c m·∫°nh.</li>
                        <li>Th√™m t√πy ch·ªçn ch·ªâ hi·ªán Th√¥ng b√°o trong khung chat.</li>
                    </ul>
                    <strong>S·ª≠a l·ªói:</strong>
                    <ul class="update-list-ul">
                        <li>S·ª≠a l·ªói Gacha t·ª± ƒë·ªông d·ª´ng.</li>
                    </ul>
                `
            },
            {
                id: 'patch_17_11', 
                title: 'Patch Update',
                date: '17/11/2025',
                content: `
                    <ul class="update-list-ul">
                        <li>Ho√†n t·∫•t di chuy·ªÉn d·ªØ li·ªáu (Data Store Migration), tƒÉng c∆∞·ªùng b·∫£o v·ªá ch·ªëng m·∫•t d·ªØ li·ªáu.</li>
                        <li>T·ªëi ∆∞u h√≥a ph·∫£n h·ªìi cho Gacha v√† Sao, bao g·ªìm c·∫£ x·ª≠ l√Ω k·∫øt n·ªëi l·∫°i.</li>
                        <li>Th√™m nh·∫°c n·ªÅn.</li>
                        <li>Hi·ªáu ·ª©ng quay Gacha Sao ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh cƒÉn gi·ªØa ch√≠nh x√°c v·ªõi m√†n h√¨nh.</li>
                        <li>Gacha gi·ªù hi·ªÉn th·ªã ƒë√∫ng ph·∫ßn th∆∞·ªüng khi chuy·ªÉn ƒë·ªïi qua l·∫°i.</li>
                        <li>Ch·∫∑n vi·ªác m·ªü Gacha v√† Sao c√πng m·ªôt l√∫c.</li>
                        <li>S·ª≠a l·ªói th∆∞·ªüng Th√†nh t·ª±u: Trang b·ªã t·ªëi ƒëa v√† T·ª∑ l·ªá r∆°i (Drops).</li>
                        <li>Ph·∫ßn th∆∞·ªüng th·ªùi gian gi·ªù s·∫Ω reset h√†ng ng√†y ƒë√∫ng nh∆∞ d·ª± ki·∫øn.</li>
                        <li>C√°c ch·∫ø ƒë·ªô ch∆°i gi·ªù ƒë√£ ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</li>
                    </ul>
                `
            },
            {
                id: 'release_pt2',
                title: 'Release PT. 2',
                date: '15/11/2025',
                content: `
                    <strong>Th√™m ch·∫ø ƒë·ªô ch∆°i m·ªõi: ƒê·ªôt k√≠ch (Raids)!</strong>
                    <ul class="update-list-ul">
                        <li>Khu v·ª±c Raid n·∫±m t·∫°i s·∫£nh Dungeon!</li>
                        <li>B·∫°n c√≥ th·ªÉ nh·∫≠n S·ª©c m·∫°nh Raid: m·ªói 5 ƒë·ª£t ho√†n th√†nh c√≥ c∆° h·ªôi r·ªõt m·ªôt c√°i!</li>
                    </ul>
                    <strong>Th√™m Gacha m·ªõi!</strong>
                    <ul class="update-list-ul">
                        <li>Ki·ªÉm tra Gacha Tr√°i c√¢y t·∫°i V√πng ƒë·∫•t Sa m·∫°c!</li>
                    </ul>
                    <strong>C·∫£i thi·ªán tr·∫£i nghi·ªám (QOL)!</strong>
                    <ul class="update-list-ul">
                        <li>ƒêi·ªÅu ch·ªânh b·∫£o hi·ªÉm Legendary (100 > 150)!</li>
                        <li>Th√™m c√†i ƒë·∫∑t D·ª´ng nh·∫≠n Qu√†!</li>
                        <li>Sao gi·ªù s·∫Ω c·ªông d·ªìn khi quay!</li>
                        <li>C·∫£i thi·ªán th·ª© t·ª± s·∫Øp x·∫øp trong Kho!</li>
                        <li>Hi·ªÉn th·ªã nhi·ªám v·ª• gi·ªù c√≥ th√™m ƒë·ªô hi·∫øm!</li>
                        <li>C·∫£i thi·ªán vi·ªác ph√¢n ph·ªëi ƒëi·ªÉm ch·ªâ s·ªë!</li>
                    </ul>
                    <strong>S·ª≠a l·ªói!</strong>
                    <ul class="update-list-ul">
                        <li>Thanh m√°u Emperor b·ªã bi·∫øn m·∫•t;</li>
                        <li>C√°c g√≥i hi·ªÉn th·ªã l√† "ƒë√£ mua" trong c·ª≠a h√†ng d√π ch∆∞a mua;</li>
                    </ul>
                `
            },
            {
                id: 'patch_14_11',
                title: 'Patch Update',
                date: '14/11/2025',
                content: `
                    <ul class="update-list-ul">
                        <li>S·ª≠a l·ªói treo game khi v√†o Dungeon.</li>
                        <li>C√¢n b·∫±ng l·∫°i s·ª©c m·∫°nh Boss th·∫ø gi·ªõi 1.</li>
                        <li>S·ª≠a l·ªói hi·ªÉn th·ªã sai s·ªë li·ªáu Mastery.</li>
                    </ul>
                `
            },
            {
                id: 'game_release',
                title: 'Game Release',
                date: '14/11/2025',
                content: 'Ph√°t h√†nh Game. Ch√∫c c√°c b·∫°n ch∆°i vui v·∫ª! Kh√°m ph√° nhi·ªÅu h√≤n ƒë·∫£o, h·ªá th·ªëng v√† th·∫ø gi·ªõi kh√°c nhau.'
            }
        ];

        // CONFIG
        const SCALING_FACTOR = 8.400;
        const BASE_COST_MAGNITUDE = 30; 
        const K_EXPONENT = 3; 
        const CPS_AUTO = 6.7;
        const CPS_NOR = 5.0; 

        const UNITS = [
            { name: '', exp: 0 }, { name: 'K', exp: 3 }, { name: 'M', exp: 6 }, { name: 'B', exp: 9 }, { name: 'T', exp: 12 }, 
            { name: 'Qa', exp: 15 }, { name: 'Qi', exp: 18 }, { name: 'Sx', exp: 21 }, { name: 'Sp', exp: 24 }, { name: 'Oc', exp: 27 }, 
            { name: 'No', exp: 30 }, { name: 'Dc', exp: 33 }, 
            { name: 'Ud', exp: 36 }, { name: 'Dd', exp: 39 }, 
            { name: 'Td', exp: 42 }, { name: 'Qad', exp: 45 }, { name: 'Qid', exp: 48 }, { name: 'Sxd', exp: 51 }, { name: 'Spd', exp: 54 }, 
            { name: 'Ocd', exp: 57 }, { name: 'Nod', exp: 60 }, { name: 'Dec', exp: 63 }, { name: 'Und', exp: 66 }, { name: 'Duo', exp: 69 },
            { name: 'Tri', exp: 72 }, { name: 'Qua', exp: 75 }, { name: 'Qui', exp: 78 }, { name: 'Six', exp: 81 }, 
            { name: 'Sep', exp: 84 }, { name: 'Oct', exp: 87 }, { name: 'Nuo', exp: 90 },
            // New Units
            { name: 'Dec', exp: 93 }, { name: 'Und', exp: 96 }, { name: 'Dud', exp: 99 }, 
            { name: 'Trd', exp: 102 }, { name: 'Qad', exp: 105 }, { name: 'Qid', exp: 108 }, 
            { name: 'Sxd', exp: 111 }, { name: 'Spd', exp: 114 }, { name: 'Ocd', exp: 117 }, 
            { name: 'Nod', exp: 120 }, { name: 'Vig', exp: 123 }
        ];

        const RANK_COSTS = {};

        // --- UTILS ---
        function formatNumber(rawVal) {
            if (rawVal === 0) return "0";
            if (rawVal < 0) return "L·ªói";
            let unitIdx = 0;
            for (let i = UNITS.length - 1; i >= 0; i--) {
                if (rawVal >= Math.pow(10, UNITS[i].exp)) { unitIdx = i; break; }
            }
            const displayVal = rawVal / Math.pow(10, UNITS[unitIdx].exp);
            const unitName = UNITS[unitIdx].name === '' ? '' : UNITS[unitIdx].name;
            return `${displayVal.toFixed(2)}${unitName}`;
        }

        function formatBigTime(totalSeconds) {
            if (!isFinite(totalSeconds) || totalSeconds <= 0) return `0<span class="time-unit">s</span>`;
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            
            const sDisplay = totalSeconds < 60 ? totalSeconds.toFixed(2) : s;

            let html = "";
            if (h > 0) html += `${h}<span class="time-unit">h</span> `;
            if (m > 0 || h > 0) html += `${m}<span class="time-unit">m</span> `;
            html += `${sDisplay}<span class="time-unit">s</span>`;
            return html;
        }

        function formatTextTime(totalSeconds) {
            if (!isFinite(totalSeconds) || totalSeconds <= 0) return "0s";
            if (totalSeconds < 60) return totalSeconds.toFixed(2) + "s";
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return (h > 0 ? `${h}h ` : "") + `${m}m`;
        }

        function getRawVal(idVal, idUnit) {
            const val = parseFloat(document.getElementById(idVal).value) || 0;
            const unitIdx = parseInt(document.getElementById(idUnit).value) || 0;
            return val * Math.pow(10, UNITS[unitIdx].exp);
        }

        function buildRankCosts() {
            let currentCost = BASE_COST_MAGNITUDE * Math.pow(10, K_EXPONENT); 
            RANK_COSTS[0] = currentCost;
            for (let i = 1; i <= 99; i++) {
                currentCost *= SCALING_FACTOR;
                RANK_COSTS[i] = currentCost;
            }
        }

        // --- UPDATE LOGIC ---
        function renderUpdateList() {
            const container = document.getElementById('versionListContainer');
            container.innerHTML = '';
            UPDATE_DATA.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = `version-item card-glow ${index === 0 ? 'active' : ''}`;
                el.onclick = () => selectUpdate(index);
                el.innerHTML = `
                    <div class="active-indicator"></div>
                    <div class="v-title">${item.title}</div>
                    <div class="v-date">${item.date}</div>
                `;
                container.appendChild(el);
            });
            initCardGlow();
            if (UPDATE_DATA.length > 0) selectUpdate(0);
        }

        function selectUpdate(index) {
            const items = document.querySelectorAll('.version-item');
            items.forEach(i => i.classList.remove('active'));
            if(items[index]) items[index].classList.add('active');

            const data = UPDATE_DATA[index];
            document.getElementById('displayUpTitle').innerText = data.title;
            document.getElementById('displayUpDate').innerText = data.date;
            document.getElementById('displayUpContent').innerHTML = data.content;
        }

        // --- MAIN LOGIC ---
        window.handleInput = function(source) {
            const activeTab = getActiveTab();
            if (activeTab === 'rank') window.calculateRank();
            else if (activeTab === 'mastery') window.calculateBoss();
            else if (activeTab === 'gacha') {
                window.calculateGacha();
            }
            else if (activeTab === 'raid') {
                window.calculateRaid(); // Still calculates but no table displayed
                window.calculateRaidTarget();
            }
            saveSettings();
        };

        window.syncClickVal = function(val) {
            document.getElementById('clickVal').value = val;
            window.handleInput();
        }
        
        window.syncClickUnit = function(val) {
            document.getElementById('clickUnit').value = val;
            window.handleInput();
        }

        function getActiveTab() {
            if (document.getElementById('rankTabBtn').classList.contains('active')) return 'rank';
            if (document.getElementById('masteryTabBtn').classList.contains('active')) return 'mastery';
            if (document.getElementById('gachaTabBtn').classList.contains('active')) return 'gacha';
            if (document.getElementById('raidTabBtn').classList.contains('active')) return 'raid';
            return 'updates';
        }

        window.syncTargetRank = function() {
            let cr = parseInt(document.getElementById('currentRank').value) || 0;
            if(cr < 0) cr = 0; if(cr > 99) cr = 99;
            document.getElementById('currentRank').value = cr;
            
            let tr = cr + 1;
            if (tr > 100) tr = 100;
            document.getElementById('targetRank').value = tr;
            
            window.calculateRank();
            saveSettings();
        };

        window.showSection = function(sectionId, shouldSave = true) {
            // Reset all tabs
            document.getElementById('rankTabBtn').classList.remove('active');
            document.getElementById('masteryTabBtn').classList.remove('active');
            document.getElementById('updateTabBtn').classList.remove('active');
            document.getElementById('gachaTabBtn').classList.remove('active');
            document.getElementById('raidTabBtn').classList.remove('active');
            
            document.getElementById('rankInputs').classList.add('hidden');
            document.getElementById('masteryInputs').classList.add('hidden');
            document.getElementById('updateInputs').classList.add('hidden');
            document.getElementById('gachaInputs').classList.add('hidden');
            document.getElementById('raidInputs').classList.add('hidden');
            
            document.getElementById('rankOutput').classList.add('hidden');
            document.getElementById('masteryOutput').classList.add('hidden');
            document.getElementById('updateOutput').classList.add('hidden');
            document.getElementById('gachaOutput').classList.add('hidden');
            document.getElementById('raidOutput').classList.add('hidden');

            // Activate specific
            if (sectionId === 'rank') {
                document.getElementById('rankTabBtn').classList.add('active');
                document.getElementById('rankInputs').classList.remove('hidden');
                document.getElementById('rankOutput').classList.remove('hidden');
                window.calculateRank();
            } else if (sectionId === 'mastery') {
                document.getElementById('masteryTabBtn').classList.add('active');
                document.getElementById('masteryInputs').classList.remove('hidden');
                document.getElementById('masteryOutput').classList.remove('hidden');
                window.calculateBoss();
            } else if (sectionId === 'updates') {
                document.getElementById('updateTabBtn').classList.add('active');
                document.getElementById('updateInputs').classList.remove('hidden');
                document.getElementById('updateOutput').classList.remove('hidden');
            } else if (sectionId === 'gacha') {
                document.getElementById('gachaTabBtn').classList.add('active');
                document.getElementById('gachaInputs').classList.remove('hidden');
                document.getElementById('gachaOutput').classList.remove('hidden');
                window.calculateGacha();
            } else if (sectionId === 'raid') {
                document.getElementById('raidTabBtn').classList.add('active');
                document.getElementById('raidInputs').classList.remove('hidden');
                document.getElementById('raidOutput').classList.remove('hidden');
                window.calculateRaid();
                window.calculateRaidTarget();
            }
            
            if(shouldSave) saveSettings();
        };

        // --- GACHA LOGIC ---
        window.setSpinMode = function(mode) {
            spinMode = mode;
            document.getElementById('spin1x').classList.toggle('active', mode === 1);
            document.getElementById('spin2x').classList.toggle('active', mode === 2);
            // document.getElementById('rollsPerCycleDisplay').innerText = mode; // Removed
            window.calculateGacha();
            saveSettings();
        }

        window.calculateGacha = function() {
            const shards = getRawVal('gachaShardsVal', 'gachaShardsUnit');
            const costPerRoll = 10;
            const baseCycleTime = 1.5; // seconds
            
            const totalRolls = Math.floor(shards / costPerRoll);
            // const cyclesNeeded = Math.ceil(totalRolls / spinMode); // Removed from display
            const totalSeconds = Math.ceil(totalRolls / spinMode) * baseCycleTime;
            
            // Update UI
            document.getElementById('gachaTimerDisplay').innerHTML = formatBigTime(totalSeconds);
            document.getElementById('gachaItemsDisplay').innerText = formatNumber(totalRolls);
            
            // Removed updates for removed elements (gachaTotalRolls, gachaCycles, rollsPerCycleDisplay)
        }

        // --- RAID LOGIC ---
        window.calculateRaid = function() {
            // Use default values from HTML if not available, defaults updated to 100/4Dc/10.4
            const refStage = parseInt(document.getElementById('raidRefStage').value) || 100;
            const refHp = getRawVal('raidRefHpVal', 'raidRefHpUnit');
            const growthRate = parseFloat(document.getElementById('raidGrowth').value) || 10.4;
            
            if(refHp <= 0) return;

            let html = `
            <tr>
                <th style="text-align:left;">Stage</th>
                <th style="text-align:right;">HP Boss</th>
                <th style="text-align:right;">Click (Fast)</th>
                <th style="text-align:right;">Click (Nor)</th>
            </tr>`;
            
            // Generate stages 100, 105, 110... (Assuming user wants to start from 100)
            
            for(let i = 100; i <= 500; i+=5) {
                let diff = i - refStage;
                let steps = diff / 5.0;
                
                let estimatedHp = refHp * Math.pow(growthRate, steps);
                
                // Calculate required click damage for 60s limit
                // DPS = HP / 60
                // ClickFast = DPS / 6.7
                // ClickNor = DPS / 5.0
                let dpsReq = estimatedHp / 60.0;
                let clickFast = dpsReq / 6.7;
                let clickNor = dpsReq / 5.0;

                let highlightClass = (i === refStage) ? "raid-hl" : "";
                let rowStyle = (i === refStage) ? "background:rgba(255,235,59,0.15);" : "";
                
                html += `<tr style="${rowStyle}">
                    <td class="${highlightClass}">Raid ${i}</td>
                    <td>${formatNumber(estimatedHp)}</td>
                    <td class="val-fast">${formatNumber(clickFast)}</td>
                    <td class="val-nor">${formatNumber(clickNor)}</td>
                </tr>`;
            }
            document.getElementById('raidTableBody').innerHTML = html;
            window.calculateRaidTarget(); // Recalc target when base params change
        }

        // Calculate specific raid stage target
        window.calculateRaidTarget = function() {
            const targetStage = parseInt(document.getElementById('raidTargetStageInput').value);
            if (!targetStage) {
                document.getElementById('raidTargetStageDisplay').innerText = "---";
                document.getElementById('raidTargetHpDisplay').innerText = "0";
                document.getElementById('raidTargetClickDmgDisplay').innerText = "0";
                // Add clear logic for new fields
                document.getElementById('raidTargetClickFast').innerText = "0";
                document.getElementById('raidTargetClickNor').innerText = "0";
                return;
            }

            const refStage = parseInt(document.getElementById('raidRefStage').value) || 100;
            const refHp = getRawVal('raidRefHpVal', 'raidRefHpUnit');
            const growthRate = parseFloat(document.getElementById('raidGrowth').value) || 10.4;

            // Calculate HP based on ref
            // Difference in steps of 5
            let diff = targetStage - refStage;
            let steps = diff / 5.0;
            let estimatedHp = refHp * Math.pow(growthRate, steps);

            // Calculate Required Click Dmg (to clear in 60s)
            // DPS = HP / 60
            let dpsReq = estimatedHp / 60;
            let reqClickFast = dpsReq / 6.7;
            let reqClickNor = dpsReq / 5.0;

            document.getElementById('raidTargetStageDisplay').innerText = targetStage;
            document.getElementById('raidTargetHpDisplay').innerText = formatNumber(estimatedHp);
            // Update new fields
            document.getElementById('raidTargetClickFast').innerText = formatNumber(reqClickFast);
            document.getElementById('raidTargetClickNor').innerText = formatNumber(reqClickNor);
        }

        // --- CALC 1: RANK ---
        window.calculateRank = function() {
            const startRank = parseInt(document.getElementById('currentRank').value) || 0;
            const endRank = parseInt(document.getElementById('targetRank').value) || 1;
            const clickVal = getRawVal('clickVal', 'clickUnit');
            const currentMastery = getRawVal('currentMasteryVal', 'currentMasteryUnit');

            if (startRank >= endRank) {
                document.getElementById('totalCostDisplay').innerText = "---";
                document.getElementById('mainTimerDisplay').innerHTML = "Ho√†n th√†nh";
                return;
            }

            let totalCost = 0;
            for (let i = startRank; i < endRank; i++) {
                if (RANK_COSTS[i]) totalCost += RANK_COSTS[i];
            }
            
            let remainingCost = totalCost - currentMastery;
            if (remainingCost < 0) remainingCost = 0;

            document.getElementById('totalCostDisplay').innerText = formatNumber(remainingCost);

            const dpsAuto = clickVal * CPS_AUTO;
            const dpsNor = clickVal * CPS_NOR;

            document.getElementById('dpsDisplay').innerText = formatNumber(dpsAuto);
            document.getElementById('dpsNorDisplay').innerText = formatNumber(dpsNor);
            
            const timeAuto = dpsAuto > 0 ? remainingCost / dpsAuto : 0;
            const timeNor = dpsNor > 0 ? remainingCost / dpsNor : 0;

            document.getElementById('mainTimerDisplay').innerHTML = formatBigTime(timeAuto);
            document.getElementById('subTimerDisplay').innerText = formatTextTime(timeNor);
        };

        // --- CALC 2: BOSS & MASTERY ---
        window.calculateBoss = function() {
            const bossHp = getRawVal('bossHpVal', 'bossHpUnit');
            const damage = getRawVal('damageVal', 'damageUnit'); 
            const mastery = getRawVal('clickVal', 'clickUnit'); 

            // 1. BOSS TIME
            const dpsDamageAuto = damage * CPS_AUTO;
            const dpsDamageNor = damage * CPS_NOR;
            
            const timeBossAuto = dpsDamageAuto > 0 ? bossHp / dpsDamageAuto : 0;
            const timeBossNor = dpsDamageNor > 0 ? bossHp / dpsDamageNor : 0;

            document.getElementById('bossTimerAuto').innerHTML = formatBigTime(timeBossAuto);
            document.getElementById('bossTimerNor').innerText = formatTextTime(timeBossNor);
            document.getElementById('bossHpDisplay').innerText = formatNumber(bossHp);
            
            // Update Damage DPS (Fast & Nor)
            document.getElementById('damageDpsDisplay').innerText = formatNumber(dpsDamageAuto);
            const dmgNorEl = document.getElementById('damageDpsNorDisplay');
            if(dmgNorEl) dmgNorEl.innerText = formatNumber(dpsDamageNor);

            // 2. MASTERY GAINED
            const h = parseFloat(document.getElementById('timeHours').value) || 0;
            const m = parseFloat(document.getElementById('timeMinutes').value) || 0;
            const s = parseFloat(document.getElementById('timeSeconds').value) || 0;
            const totalSeconds = (h*3600) + (m*60) + s;

            const gainedAuto = mastery * CPS_AUTO * totalSeconds;
            const gainedNor = mastery * CPS_NOR * totalSeconds;
            
            document.getElementById('masteryGainedDisplay').innerText = formatNumber(gainedAuto);
            const mastNorEl = document.getElementById('masteryGainedNorDisplay');
            if(mastNorEl) mastNorEl.innerText = formatNumber(gainedNor);
        };

        // --- INITIALIZATION & FIREBASE ---
        function initUI() {
            buildRankCosts();
            renderUpdateList(); 

            const unitSelects = ['clickUnit', 'bossHpUnit', 'damageUnit', 'currentMasteryUnit', 'clickUnitDup', 'gachaShardsUnit', 'raidRefHpUnit'];
            unitSelects.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = '';
                UNITS.forEach((u, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = u.name || '';
                    if(u.name === 'K') opt.selected = true;
                    // Default Dc for Raid Ref (Index 11) since raid 100 is ~4 Dc
                    if(id === 'raidRefHpUnit' && u.name === 'Dc') opt.selected = true; 
                    el.appendChild(opt);
                });
            });

            // Sync dup inputs
            document.getElementById('clickUnitDup').value = document.getElementById('clickUnit').value;
            document.getElementById('clickValDup').value = document.getElementById('clickVal').value;
            
            // Set default for raidRefHpUnit to Dc explicitly if loop didn't catch it right
            const dcIndex = UNITS.findIndex(u => u.name === 'Dc');
            if(dcIndex > -1 && document.getElementById('raidRefHpUnit')) {
                 document.getElementById('raidRefHpUnit').value = dcIndex;
            }

            initCardGlow(); 
        }

        function initCardGlow() {
            document.querySelectorAll('.card-glow').forEach(card => {
                card.onmousemove = e => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                };
            });
        }

        async function saveSettings() {
            if (!userId || !db) return;
            const settings = {
                activeTab: getActiveTab(),
                currentMasteryVal: document.getElementById('currentMasteryVal').value,
                currentMasteryUnit: document.getElementById('currentMasteryUnit').value,
                clickVal: document.getElementById('clickVal').value,
                clickUnit: document.getElementById('clickUnit').value,
                damageVal: document.getElementById('damageVal').value,
                damageUnit: document.getElementById('damageUnit').value,
                currentRank: document.getElementById('currentRank').value,
                targetRank: document.getElementById('targetRank').value,
                bossHpVal: document.getElementById('bossHpVal').value,
                bossHpUnit: document.getElementById('bossHpUnit').value,
                timeHours: document.getElementById('timeHours').value,
                timeMinutes: document.getElementById('timeMinutes').value,
                timeSeconds: document.getElementById('timeSeconds').value,
                gachaShardsVal: document.getElementById('gachaShardsVal').value,
                gachaShardsUnit: document.getElementById('gachaShardsUnit').value,
                spinMode: spinMode,
                raidRefStage: document.getElementById('raidRefStage').value,
                raidRefHpVal: document.getElementById('raidRefHpVal').value,
                raidRefHpUnit: document.getElementById('raidRefHpUnit').value,
                raidGrowth: document.getElementById('raidGrowth').value,
                raidTargetStageInput: document.getElementById('raidTargetStageInput').value
            };
            try { await setDoc(doc(db, userSettingsPath, userId, 'app_data', settingsDocName), settings); } 
            catch (e) { console.error(e); }
        }

        async function loadSettings() {
            if (!userId || !db) return;
            try {
                const snap = await getDoc(doc(db, userSettingsPath, userId, 'app_data', settingsDocName));
                if (snap.exists()) {
                    const s = snap.data();
                    
                    document.getElementById('currentMasteryVal').value = s.currentMasteryVal || '0';
                    document.getElementById('currentMasteryUnit').value = s.currentMasteryUnit || '1';
                    
                    document.getElementById('clickVal').value = s.clickVal || '0';
                    document.getElementById('clickUnit').value = s.clickUnit || '1';
                    
                    document.getElementById('clickValDup').value = s.clickVal || '0';
                    document.getElementById('clickUnitDup').value = s.clickUnit || '1';

                    document.getElementById('damageVal').value = s.damageVal || '0';
                    document.getElementById('damageUnit').value = s.damageUnit || '1';
                    document.getElementById('currentRank').value = s.currentRank || '0';
                    document.getElementById('targetRank').value = s.targetRank || '1';
                    document.getElementById('bossHpVal').value = s.bossHpVal || '0';
                    document.getElementById('bossHpUnit').value = s.bossHpUnit || '1';
                    document.getElementById('timeHours').value = s.timeHours || '0';
                    document.getElementById('timeMinutes').value = s.timeMinutes || '0';
                    document.getElementById('timeSeconds').value = s.timeSeconds || '0';
                    
                    document.getElementById('gachaShardsVal').value = s.gachaShardsVal || '0';
                    document.getElementById('gachaShardsUnit').value = s.gachaShardsUnit || '1';
                    if(s.spinMode) window.setSpinMode(s.spinMode);

                    if(s.raidRefStage) document.getElementById('raidRefStage').value = s.raidRefStage;
                    if(s.raidRefHpVal) document.getElementById('raidRefHpVal').value = s.raidRefHpVal;
                    if(s.raidRefHpUnit) document.getElementById('raidRefHpUnit').value = s.raidRefHpUnit;
                    if(s.raidGrowth) document.getElementById('raidGrowth').value = s.raidGrowth;
                    
                    if(s.raidTargetStageInput) document.getElementById('raidTargetStageInput').value = s.raidTargetStageInput;

                    const tab = s.activeTab || 'rank';
                    setTimeout(() => { window.showSection(tab, false); }, 50);
                } else { window.handleInput(); }
            } catch (e) { window.handleInput(); }
        }

        async function setupFirebase() {
            if (!firebaseConfig?.apiKey) return;
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch { await signInAnonymously(auth); }
            onAuthStateChanged(auth, (u) => { if(u) { userId = u.uid; loadSettings(); } });
        }

        window.handleInput = handleInput;
        window.syncTargetRank = syncTargetRank;
        window.showSection = showSection;
        window.calculateRank = calculateRank;
        window.calculateBoss = calculateBoss;
        window.calculateGacha = calculateGacha;
        window.calculateRaid = calculateRaid;
        window.calculateRaidTarget = calculateRaidTarget;
        window.setSpinMode = setSpinMode;
        window.selectUpdate = selectUpdate;
        window.syncClickVal = syncClickVal;
        window.syncClickUnit = syncClickUnit;

        window.onload = () => { initUI(); setupFirebase(); };
    </script>
    
    <!-- Anti-F12 and Copy Scripts -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { // F12
                return false;
            }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
                return false;
            }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
                return false;
            }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
                return false;
            }
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U
                return false;
            }
        }
    </script>
</body>
</html>