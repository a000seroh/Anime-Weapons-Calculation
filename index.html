<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AW.Calc - Mastery & Damage</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #050505;
            --bg-card: #0f0f0f;
            --bg-input: #000000;
            --border-color: #222;
            --accent-primary: #2962ff;
            --accent-glow: rgba(41, 98, 255, 0.4);
            --accent-text: #448aff;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --text-value: #e0e0e0;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
            --bg-update-item: #151515;
            --bg-update-active: #2962ff;
            
            /* Tab Colors */
            --col-rank: #2962ff;
            --col-boss: #ff5722;
            --col-gacha: #d500f9;
            --col-raid: #ffeb3b;
            --col-defense: #00e5ff;
            --col-shadow: #7c4dff;
            --col-update: #00e676;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-sans);
            margin: 0;
            padding: 20px; 
            display: flex;
            flex-direction: column; 
            align-items: center;    
            min-height: 100vh;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea { -webkit-user-select: text; -ms-user-select: text; user-select: text; }

        .app-container { display: flex; flex-direction: column; gap: 24px; max-width: 1200px; width: 100%; flex: 1; }

        /* Header */
        .brand-header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 10px; gap: 10px; }
        .brand-logo { width: 80px; height: 80px; object-fit: cover; border-radius: 18px; box-shadow: 0 8px 25px rgba(41, 98, 255, 0.15); border: 1px solid #333; transition: transform 0.3s ease; margin-bottom: 5px; }
        .brand-logo:hover { transform: scale(1.05) rotate(2deg); }
        .brand-title { font-family: var(--font-sans); font-size: 28px; font-weight: 800; color: #fff; margin: 0; line-height: 1.2; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .title-icon { font-size: 24px; opacity: 0.8; margin-right: 2px; }
        .brand-title span { color: var(--accent-primary); } 
        .brand-subtitle { font-size: 13px; color: var(--text-secondary); font-weight: 500; font-family: var(--font-sans); }

        /* Nav Bar */
        .nav-tabs-container { background: #0a0a0a; padding: 8px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; z-index: 10; }
        .nav-tabs { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .nav-btn { background: transparent; border: none; color: #555; padding: 14px 4px; font-family: var(--font-sans); font-weight: 800; font-size: 11px; cursor: pointer; border-radius: 12px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px; text-align: center; }
        .nav-btn:hover { color: #fff; background-color: rgba(255,255,255,0.03); }
        #rankTabBtn.active { background-color: var(--col-rank); color: #fff; box-shadow: 0 4px 15px rgba(41, 98, 255, 0.3); }
        #bossTabBtn.active { background-color: var(--col-boss); color: #fff; box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3); }
        #gachaTabBtn.active { background-color: var(--col-gacha); color: #fff; box-shadow: 0 4px 15px rgba(213, 0, 249, 0.3); }
        #raidTabBtn.active { background-color: var(--col-raid); color: #000; box-shadow: 0 4px 15px rgba(255, 235, 59, 0.3); }
        #defenseTabBtn.active { background-color: var(--col-defense); color: #000; box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3); }
        #shadowTabBtn.active { background-color: var(--col-shadow); color: #fff; box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3); }

        .content-grid { display: grid; grid-template-columns: 340px 1fr; gap: 24px; width: 100%; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }

        /* Cards */
        .card-glow { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; position: relative; }
        .card-glow::before { content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1.5px; background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), var(--accent-glow), transparent 40%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; z-index: 2; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; }
        .card-glow:hover::before { opacity: 1; }
        .control-card { padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1; }

        /* Inputs */
        .control-section { margin-bottom: 20px; }
        .control-section:last-child { margin-bottom: 0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .label-text { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px;}
        .label-text::before { content:''; width: 4px; height: 4px; background: var(--accent-text); display: inline-block; border-radius: 50%; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-wrapper { background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 10px; padding: 0 12px; height: 48px; display: flex; align-items: center; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-wrapper:focus-within { border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-glow); }
        input, select { background: transparent; border: none; color: #fff; font-family: var(--font-mono); font-size: 15px; width: 100%; height: 100%; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        select { color: var(--accent-text); font-weight: 700; text-align: right; cursor: pointer; min-width: 60px; }
        select option { background-color: #000; color: #fff; }
        .time-input-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

        /* Buttons */
        .player-mode-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; margin-top: 10px; }
        .player-btn { background: var(--bg-input); border: 1px solid var(--border-color); color: #666; padding: 10px; border-radius: 10px; font-family: var(--font-mono); font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 12px; text-align: center; }
        .player-btn:hover { color: #fff; border-color: #444; }
        .player-btn.active { background: rgba(0, 229, 255, 0.15); border-color: var(--col-defense); color: var(--col-defense); box-shadow: 0 0 10px rgba(0, 229, 255, 0.15); }
        
        .spin-mode-group { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 5px; }
        .spin-btn { background: var(--bg-input); border: 1px solid var(--border-color); color: #666; padding: 10px 4px; border-radius: 10px; font-family: var(--font-mono); font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 11px; text-align: center;}
        .spin-btn:hover { color: #fff; border-color: #444; }
        .spin-btn.active { background: rgba(213, 0, 249, 0.1); border-color: var(--col-gacha); color: var(--col-gacha); box-shadow: 0 0 15px rgba(213, 0, 249, 0.1); }

        /* Table Styles (Used for boss team table) */
        .raid-table-container { height: auto; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; background: #0a0a0a; overflow-x: auto; }
        .raid-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .raid-table th { position: sticky; top: 0; background: #151515; color: var(--col-raid); padding: 12px; font-size: 12px; text-align: right; z-index: 2; border-bottom: 1px solid #333; white-space: nowrap; }
        .raid-table th:first-child { text-align: left; }
        .raid-table td { padding: 10px 12px; border-bottom: 1px solid #222; font-family: var(--font-mono); font-size: 13px; color: #ddd; text-align: right; }
        .raid-table td:first-child { text-align: left; color: var(--col-raid); font-weight: 700; }
        .raid-table tr:hover { background: rgba(255, 235, 59, 0.05); }
        .val-fast { color: var(--accent-text); }
        .val-nor { color: #888; }
        .boss-table th { color: var(--col-boss); }
        .boss-table td:first-child { color: var(--col-boss); }
        .boss-table tr:hover { background: rgba(255, 87, 34, 0.05); }
        .status-ok { color: #00e676; font-weight: bold; }
        .status-fail { color: #ff1744; font-weight: bold; }

        /* Timer Card */
        .timer-card { padding: 40px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-height: 220px; --accent-glow: rgba(41, 98, 255, 0.8); }
        .timer-label { font-size: 12px; letter-spacing: 2px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 16px; font-weight: 700; }
        .big-time { font-family: var(--font-mono); font-size: 64px; font-weight: 700; color: #fff; text-shadow: 0 0 30px rgba(41, 98, 255, 0.3); line-height: 1; margin-bottom: 16px; }
        .time-unit { font-size: 0.5em; color: var(--text-secondary); font-weight: 400; margin-right: 6px;}
        .sub-info { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; }
        .highlight { color: var(--accent-text); font-weight: bold; margin-left: 5px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .stat-card { padding: 24px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .stat-title { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-icon { font-size: 18px; opacity: 0.7; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stat-row:last-child { margin-bottom: 0; }
        .stat-value-sm { font-family: var(--font-mono); font-size: 20px; font-weight: 700; color: #fff; }
        .stat-label-sm { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .accent-fast { color: var(--accent-text); }
        .accent-nor { color: #888; }
        .stat-value { font-family: var(--font-mono); font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 8px; line-height: 1; }
        .stat-sub { font-size: 12px; color: var(--text-secondary); }
        
        /* Compact Boss Card */
        .compact-card { padding: 16px; min-height: auto; }
        .compact-card .stat-header { margin-bottom: 8px; }
        .compact-card .stat-row { margin-bottom: 6px; }
        .compact-card .stat-value-sm { font-size: 18px; }

        /* Update Details */
        .update-card { padding: 0; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-height: 400px; display: flex; flex-direction: column; }
        .update-header-box { background: #111; padding: 24px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .up-title { font-family: var(--font-mono); font-size: 22px; font-weight: 800; color: #fff; }
        .up-date { font-family: var(--font-mono); font-size: 13px; color: var(--col-update); background: rgba(0, 230, 118, 0.1); padding: 6px 12px; border-radius: 8px; font-weight: 700;}
        .update-content { padding: 30px; font-size: 14px; line-height: 1.8; color: #ddd; flex: 1; }
        
        .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #444; font-family: var(--font-mono); }

        @media (max-width: 850px) {
            .content-grid { grid-template-columns: 1fr; }
            .nav-tabs { grid-template-columns: 1fr 1fr 1fr; }
            .brand-header { justify-content: center; }
            .big-time { font-size: 48px; }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="brand-header">
            <img src="favicon.png" alt="Logo" class="brand-logo">
            <h1 class="brand-title"><span class="title-icon">‚öîÔ∏è</span> Anime Weapons <span>Calc</span></h1>
            <div class="brand-subtitle">C√¥ng c·ª• t√≠nh to√°n m·ªçi th·ª© c√≥ trong Anime Weapons</div>
        </div>

        <div class="nav-tabs-container card-glow">
            <div class="nav-tabs">
                <button class="nav-btn active" id="rankTabBtn" onclick="window.showSection('rank')">Rank</button>
                <button class="nav-btn" id="bossTabBtn" onclick="window.showSection('boss')">Boss</button>
                <button class="nav-btn" id="gachaTabBtn" onclick="window.showSection('gacha')">Mastery/Gacha</button>
                <button class="nav-btn" id="raidTabBtn" onclick="window.showSection('raid')">Raid</button>
                <button class="nav-btn" id="defenseTabBtn" onclick="window.showSection('defense')">Defense</button>
                <button class="nav-btn" id="shadowTabBtn" onclick="window.showSection('shadow')">Shadow Gate</button>
            </div>
        </div>

        <div class="content-grid">
            <!-- LEFT PANEL: INPUTS -->
            <div class="left-panel">
                <div class="control-card card-glow">
                    
                    <!-- RANK INPUTS -->
                    <div id="rankInputs">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">RANK HI·ªÜN T·∫†I</span></div>
                            <div class="input-wrapper"><input type="number" id="currentRank" min="0" max="100" value="0" oninput="window.syncTargetRank()"></div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">RANK M·ª§C TI√äU</span></div>
                            <div class="input-wrapper"><input type="number" id="targetRank" min="1" max="100" value="1" oninput="window.calculate(); window.handleInput()"></div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">MASTERY M·ªñI CLICK</span></div>
                            <div class="input-row"><div class="input-wrapper"><input type="number" step="any" id="clickVal" placeholder="0" oninput="window.syncFromTo('clickVal', 'clickValDup'); window.handleInput('clickVal')"><select id="clickUnit" onchange="window.syncFromTo('clickUnit', 'clickUnitDup'); window.handleInput('clickUnit')"></select></div></div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">MASTERY ƒêANG C√ì</span></div>
                            <div class="input-row"><div class="input-wrapper"><input type="number" step="any" id="currentMasteryVal" placeholder="0" oninput="window.handleInput('currentMasteryVal')"><select id="currentMasteryUnit" onchange="window.handleInput('currentMasteryUnit')"></select></div></div>
                        </div>
                        <div style="font-size:13px; color:#aaa; margin-top:15px; font-style:italic; text-align:center; line-height:1.5; font-weight:600;">*M·ªçi th·ª© t√≠nh to√°n ch·ªâ l√† t∆∞∆°ng ƒë·ªëi.<br>T·ª´ Rank 40 tr·ªü ƒëi t·ª∑ l·ªá tƒÉng kho·∫£ng 8.7 l·∫ßn.</div>
                    </div>

                    <!-- BOSS INPUTS -->
                    <div id="bossInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">M√ÅU BOSS (HP)</span></div>
                            <div class="input-row"><div class="input-wrapper"><input type="number" step="any" id="bossHpVal" placeholder="0" oninput="window.handleInput('bossHpVal')"><select id="bossHpUnit" onchange="window.handleInput('bossHpUnit')"></select></div></div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">S√ÅT TH∆Ø∆†NG CLICK (NG∆Ø·ªúI 1)</span></div>
                            <div class="input-row"><div class="input-wrapper"><input type="number" step="any" id="damageVal" placeholder="0" oninput="window.handleInput('damageVal')"><select id="damageUnit" onchange="window.handleInput('damageUnit')"></select></div></div>
                        </div>
                        <div class="control-section" style="border-top:1px dashed #333; padding-top:15px; margin-top:15px;">
                             <div class="section-header"><span class="label-text" style="color:var(--col-boss);">NH√ìM SƒÇN BOSS (T√ôY CH·ªåN)</span></div>
                             <!-- Players 2-10 -->
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P2</span><input type="number" step="any" id="p2DmgVal" placeholder="Nh·∫≠p DMG P2" oninput="window.calculateBoss()"><select id="p2DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P3</span><input type="number" step="any" id="p3DmgVal" placeholder="Nh·∫≠p DMG P3" oninput="window.calculateBoss()"><select id="p3DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P4</span><input type="number" step="any" id="p4DmgVal" placeholder="Nh·∫≠p DMG P4" oninput="window.calculateBoss()"><select id="p4DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P5</span><input type="number" step="any" id="p5DmgVal" placeholder="Nh·∫≠p DMG P5" oninput="window.calculateBoss()"><select id="p5DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P6</span><input type="number" step="any" id="p6DmgVal" placeholder="Nh·∫≠p DMG P6" oninput="window.calculateBoss()"><select id="p6DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P7</span><input type="number" step="any" id="p7DmgVal" placeholder="Nh·∫≠p DMG P7" oninput="window.calculateBoss()"><select id="p7DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P8</span><input type="number" step="any" id="p8DmgVal" placeholder="Nh·∫≠p DMG P8" oninput="window.calculateBoss()"><select id="p8DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P9</span><input type="number" step="any" id="p9DmgVal" placeholder="Nh·∫≠p DMG P9" oninput="window.calculateBoss()"><select id="p9DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                             <div class="input-row" style="margin-bottom:8px;"><div class="input-wrapper"><span style="font-size:12px; color:#888; margin-right:8px; min-width:20px;">P10</span><input type="number" step="any" id="p10DmgVal" placeholder="Nh·∫≠p DMG P10" oninput="window.calculateBoss()"><select id="p10DmgUnit" onchange="window.calculateBoss()"></select></div></div>
                        </div>
                    </div>

                    <!-- GACHA INPUTS -->
                    <div id="gachaInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">T·ªîNG SHARDS (M·∫¢NH)</span></div>
                            <div class="input-row"><div class="input-wrapper"><input type="number" step="any" id="gachaShardsVal" placeholder="0" oninput="window.calculateGacha()"><select id="gachaShardsUnit" onchange="window.calculateGacha()"></select></div></div>
                        </div>
                        <div class="control-section">
                            <div class="section-header"><span class="label-text">CH·∫æ ƒê·ªò QUAY</span></div>
                            <div class="spin-mode-group">
                                <button class="spin-btn active" id="spin1x" onclick="window.setSpinMode(1)">1x</button>
                                <button class="spin-btn" id="spin2x" onclick="window.setSpinMode(2)">2x</button>
                                <button class="spin-btn" id="spin3x" onclick="window.setSpinMode(3)">3x</button>
                                <button class="spin-btn" id="spin4x" onclick="window.setSpinMode(4)">4x</button>
                                <button class="spin-btn" id="spin5x" onclick="window.setSpinMode(5)">5x</button>
                            </div>
                            <div style="font-size:11px; color:#666; text-align:center; margin-top:5px;">C∆° b·∫£n: 1.5s / l∆∞·ª£t</div>
                        </div>
                        <div class="control-section" style="border-top:1px dashed #333; padding-top:20px; margin-top:20px;">
                            <div class="section-header"><span class="label-text" style="color:var(--col-gacha);">T√çNH MASTERY NH·∫¨N ƒê∆Ø·ª¢C</span></div>
                            <div class="section-header"><span class="label-text">MASTERY M·ªñI CLICK</span></div>
                            <div class="input-row"><div class="input-wrapper"><input type="number" step="any" id="clickValDup" placeholder="0" oninput="window.syncFromTo('clickValDup', 'clickVal'); window.handleInput('clickValDup')"><select id="clickUnitDup" onchange="window.syncFromTo('clickUnitDup', 'clickUnit'); window.handleInput('clickUnitDup')"></select></div></div>
                            <div class="section-header" style="margin-top:15px;"><span class="label-text">TH·ªúI GIAN C√ÄY</span></div>
                            <div class="time-input-group">
                                <div class="input-wrapper"><input type="number" step="any" id="timeDays" placeholder="Ng√†y" oninput="window.calculateMasteryGained()"></div>
                                <div class="input-wrapper"><input type="number" step="any" id="timeHours" placeholder="Gi·ªù" oninput="window.calculateMasteryGained()"></div>
                                <div class="input-wrapper"><input type="number" step="any" id="timeMinutes" placeholder="Ph√∫t" oninput="window.calculateMasteryGained()"></div>
                            </div>
                        </div>
                    </div>

                    <!-- RAID INPUTS -->
                    <div id="raidInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text" style="color:var(--col-raid);">T√çNH TO√ÅN ·∫¢I C·ª§ TH·ªÇ</span></div>
                            <div class="section-header"><span class="label-text">S·ªê ·∫¢I MU·ªêN CH·ªåN</span></div>
                            <div class="input-wrapper"><input type="number" id="raidTargetStageInput" placeholder="Nh·∫≠p s·ªë ·∫£i (V√≠ d·ª•: 180)" step="5" oninput="window.calculateRaidTarget()"></div>
                             <div style="font-size:13px; color:#aaa; margin-top:8px; font-style:italic; font-weight:600; text-align:center;">*M·ªçi th·ª© t√≠nh to√°n ch·ªâ l√† t∆∞∆°ng ƒë·ªëi.<br>HP Boss tƒÉng kho·∫£ng 10.5 l·∫ßn sau m·ªói 5 ·∫£i (Solo).</div>
                        </div>
                        <div class="control-section" style="border-top:1px dashed #333; padding-top:15px; margin-top:15px;">
                            <div class="section-header"><span class="label-text" style="color:var(--col-raid);">T√çNH PITY SECRET RAID</span></div>
                            <div class="section-header"><span class="label-text">PITY HI·ªÜN T·∫†I (M·ª§C TI√äU 5000)</span></div>
                            <div class="input-wrapper"><input type="number" id="raidPityCurrent" placeholder="0" oninput="window.calculateRaidPity()"></div>
                            <div class="section-header" style="margin-top:10px;"><span class="label-text">S·ªê WAVE M·ªñI L·∫¶N ƒêI</span></div>
                            <div class="input-wrapper"><input type="number" id="raidWavePerRun" placeholder="Nh·∫≠p s·ªë wave (V√≠ d·ª•: 50)" oninput="window.calculateRaidPity()"></div>
                            <div style="font-size:11px; color:#666; text-align:center; margin-top:5px;">Gi·∫£ ƒë·ªãnh: 2 l·∫ßn / 1 gi·ªù</div>
                        </div>
                        <div class="control-section" style="display:none;"> 
                            <div class="input-wrapper"><input type="number" step="any" id="raidRefStage" value="100" oninput="window.calculateRaidTarget()"></div>
                            <div class="input-wrapper"><input type="number" step="any" id="raidRefHpVal" value="4" oninput="window.calculateRaidTarget()"><select id="raidRefHpUnit" onchange="window.calculateRaidTarget()"></select></div>
                            <div class="input-wrapper"><input type="number" step="any" id="raidGrowth" value="10.5" oninput="window.calculateRaidTarget()"></div>
                        </div>
                    </div>

                    <!-- DEFENSE INPUTS -->
                    <div id="defenseInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text" style="color:var(--col-defense);">T√çNH WAVE C·ª§ TH·ªÇ</span></div>
                            <div class="section-header"><span class="label-text">S·ªê WAVE MU·ªêN CH·ªåN</span></div>
                            <div class="input-wrapper"><input type="number" id="defTargetWaveInput" placeholder="Nh·∫≠p s·ªë wave (V√≠ d·ª•: 70)" step="5" oninput="window.calculateDefenseTarget()"></div>
                             <div style="font-size:13px; color:#aaa; margin-top:8px; font-style:italic; font-weight:600; text-align:center;">*M·ªçi th·ª© t√≠nh to√°n ch·ªâ l√† t∆∞∆°ng ƒë·ªëi.<br>*HP qu√°i tƒÉng tr∆∞·ªüng kho·∫£ng 10.9 l·∫ßn m·ªói 5 wave.<br>*L∆∞u √Ω: Ch·ªâ t√≠nh m√°u Boss (Solo), ch∆∞a t√≠nh qu√°i con.</div>
                        </div>
                        <div class="control-section" style="border-top:1px dashed #333; padding-top:15px; margin-top:15px;">
                            <div class="section-header"><span class="label-text" style="color:var(--col-defense);">T√çNH PITY SECRET DEFENSE</span></div>
                            <div class="section-header"><span class="label-text">PITY HI·ªÜN T·∫†I (M·ª§C TI√äU 4000)</span></div>
                            <div class="input-wrapper"><input type="number" id="defPityCurrent" placeholder="0" oninput="window.calculateDefensePity()"></div>
                            <div class="section-header" style="margin-top:10px;"><span class="label-text">S·ªê WAVE M·ªñI L·∫¶N ƒêI</span></div>
                            <div class="input-wrapper"><input type="number" id="defWavePerRun" placeholder="Nh·∫≠p s·ªë wave (V√≠ d·ª•: 50)" oninput="window.calculateDefensePity()"></div>
                            <div style="font-size:11px; color:#666; text-align:center; margin-top:5px;">Gi·∫£ ƒë·ªãnh: 2 l·∫ßn / 1 gi·ªù</div>
                        </div>
                        <div class="control-section" style="display:none;"> 
                            <div class="input-wrapper"><input type="number" step="any" id="defRefWave" value="50" oninput="window.calculateDefenseTarget()"></div>
                            <div class="input-wrapper"><input type="number" step="any" id="defRefHpVal" value="3" oninput="window.calculateDefenseTarget()"><select id="defRefHpUnit" onchange="window.calculateDefenseTarget()"></select></div>
                            <div class="input-wrapper"><input type="number" step="any" id="defGrowth" value="11" oninput="window.calculateDefenseTarget()"></div>
                        </div>
                    </div>

                    <!-- SHADOW GATE INPUTS -->
                    <div id="shadowInputs" class="hidden">
                        <div class="control-section">
                            <div class="section-header"><span class="label-text" style="color:var(--col-shadow);">T√çNH WAVE C·ª§ TH·ªÇ</span></div>
                            <div class="section-header"><span class="label-text">S·ªê WAVE MU·ªêN CH·ªåN</span></div>
                            <div class="input-wrapper"><input type="number" id="shadowTargetWaveInput" placeholder="Nh·∫≠p s·ªë wave (V√≠ d·ª•: 60)" step="5" oninput="window.calculateShadowTarget()"></div>
                             <div style="font-size:13px; color:#aaa; margin-top:8px; font-style:italic; font-weight:600; text-align:center;">*M·ªçi th·ª© t√≠nh to√°n ch·ªâ l√† t∆∞∆°ng ƒë·ªëi.<br>HP Boss tƒÉng kho·∫£ng 10.7 l·∫ßn sau m·ªói 5 wave.</div>
                        </div>
                        <div class="control-section" style="border-top:1px dashed #333; padding-top:15px; margin-top:15px;">
                            <div class="section-header"><span class="label-text" style="color:var(--col-shadow);">T√çNH PITY SECRET SHADOW</span></div>
                            <div class="section-header"><span class="label-text">PITY HI·ªÜN T·∫†I (M·ª§C TI√äU 5000)</span></div>
                            <div class="input-wrapper"><input type="number" id="shadowPityCurrent" placeholder="0" oninput="window.calculateShadowPity()"></div>
                            <div class="section-header" style="margin-top:10px;"><span class="label-text">S·ªê WAVE M·ªñI L·∫¶N ƒêI</span></div>
                            <div class="input-wrapper"><input type="number" id="shadowWavePerRun" placeholder="Nh·∫≠p s·ªë wave (V√≠ d·ª•: 65)" oninput="window.calculateShadowPity()"></div>
                            <div style="font-size:11px; color:#666; text-align:center; margin-top:5px;">Gi·∫£ ƒë·ªãnh: 2 l·∫ßn / 1 gi·ªù</div>
                        </div>
                        <div class="control-section" style="display:none;"> 
                            <div class="input-wrapper"><input type="number" step="any" id="shadowRefWave" value="45" oninput="window.calculateShadowTarget()"></div>
                            <div class="input-wrapper"><input type="number" step="any" id="shadowRefHpVal" value="28.13" oninput="window.calculateShadowTarget()"><select id="shadowRefHpUnit" onchange="window.calculateShadowTarget()"></select></div>
                            <div class="input-wrapper"><input type="number" step="any" id="shadowGrowth" value="10.7" oninput="window.calculateShadowTarget()"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === C·ªòT PH·∫¢I: K·∫æT QU·∫¢ === -->
            <div class="right-panel">
                <!-- RANK -->
                <div id="rankOutput">
                    <div class="timer-card card-glow">
                        <div class="timer-label">TH·ªúI GIAN C√íN L·∫†I (FAST 6.7X)</div>
                        <div class="big-time" id="mainTimerDisplay">0<span class="time-unit">s</span></div>
                        <div class="sub-info">Nor (5x): <span class="highlight" id="subTimerDisplay">0s</span></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card card-glow" style="justify-content:center;">
                            <div class="stat-header" style="border:none; margin-bottom:5px;"><div class="stat-title">T·ªîNG MASTERY C·∫¶N</div></div>
                            <div class="stat-value" id="totalCostDisplay">0</div>
                            <div class="stat-sub">ƒê√£ tr·ª´ s·ªë ƒëang c√≥</div>
                        </div>
                        <div class="stat-card card-glow">
                            <div class="stat-header"><div class="stat-title">T·ªêC ƒê·ªò C√ÄY</div><div class="stat-icon">‚ö°</div></div>
                            <div class="stat-row"><div class="stat-col-val"><div class="stat-value-sm accent-fast" id="dpsDisplay">0</div><div class="stat-label-sm">Fast (6.7x)</div></div></div>
                            <div class="stat-row" style="border-top:1px dashed #333; padding-top:10px;"><div class="stat-col-val"><div class="stat-value-sm accent-nor" id="dpsNorDisplay">0</div><div class="stat-label-sm">Nor (5.0x)</div></div></div>
                        </div>
                    </div>
                </div>

                <!-- BOSS -->
                <div id="bossOutput" class="hidden">
                    <div class="timer-card card-glow">
                        <div class="timer-label">TH·ªúI GIAN H·∫† BOSS (NH√ìM)</div>
                        <div class="big-time" id="bossTimerAuto">0<span class="time-unit">s</span></div>
                        <div class="sub-info">Nor (5x): <span class="highlight" id="bossTimerNor">0s</span></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div class="stat-card card-glow compact-card">
                            <div class="stat-header" style="margin-bottom:12px;"><div class="stat-title">TH√îNG TIN BOSS</div><div class="stat-icon">ü©∏</div></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                                <div>
                                    <div class="stat-value-sm" id="bossHpDisplay">0</div>
                                    <div class="stat-label-sm">M√°u Boss</div>
                                </div>
                                <div style="border-left: 1px solid #333; padding-left: 20px;">
                                    <div class="stat-value-sm accent-fast" id="damageDpsDisplay">0</div>
                                    <div class="stat-label-sm">T·ªïng DPS Team (Fast + Crit)</div>
                                </div>
                            </div>
                        </div>
                        <div class="update-card card-glow">
                            <div class="update-header-box">
                                <div class="up-title" style="color:var(--col-boss);">ƒêi·ªÅu ki·ªán nh·∫≠n ƒë·ªì (15%)</div>
                                <div class="up-date" style="background:rgba(255,87,34,0.1); color:var(--col-boss);" id="dmgRequiredDisplay">C·∫ßn: 0</div>
                            </div>
                            <div class="raid-table-container" style="height:auto; max-height:none; overflow:visible;">
                                <table class="raid-table boss-table" id="bossTeamTable"></table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GACHA -->
                <div id="gachaOutput" class="hidden">
                    <div class="timer-card card-glow" style="--accent-glow: rgba(213, 0, 249, 0.6); margin-bottom: 20px;">
                        <div class="timer-label">TH·ªúI GIAN GACHA D·ª∞ KI·∫æN</div>
                        <div class="big-time" id="gachaTimerDisplay">0<span class="time-unit">s</span></div>
                        <div class="sub-info">M·ªü <span class="highlight" id="gachaItemsDisplay">0</span> v·∫≠t ph·∫©m</div>
                    </div>
                    <div class="stat-card card-glow" style="border-color: var(--col-gacha);">
                        <div class="stat-header"><div class="stat-title">MASTERY ƒê·∫†T ƒê∆Ø·ª¢C</div><div class="stat-icon">üì¶</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value-sm accent-fast" id="masteryGainedDisplay">0</div><div class="stat-label-sm">Fast (6.7x)</div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #333; padding-top:10px; margin-top:10px;"><div class="stat-col-val"><div class="stat-value-sm accent-nor" id="masteryGainedNorDisplay">0</div><div class="stat-label-sm">Nor (5.0x)</div></div></div>
                    </div>
                </div>

                <!-- RAID -->
                <div id="raidOutput" class="hidden">
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-raid);">
                        <div class="stat-header"><div class="stat-title">SECRET RAID PITY (5000)</div><div class="stat-icon">üíé</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value" id="raidPityRunsDisplay">0</div><div class="stat-label-sm">S·ªë l·∫ßn c·∫ßn ƒëi</div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val"><div class="stat-value-sm accent-fast" id="raidPityTimeDisplay">0h</div><div class="stat-label-sm">Th·ªùi gian d·ª± ki·∫øn</div></div>
                        </div>
                    </div>
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-raid);">
                        <div class="stat-header"><div class="stat-title">K·∫æT QU·∫¢ T√çNH TO√ÅN ·∫¢I <span id="raidTargetStageDisplay" style="color:#fff;">---</span></div><div class="stat-icon">üéØ</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value" id="raidTargetHpDisplay">0</div><div class="stat-label-sm">M√°u Boss D·ª± Ki·∫øn</div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val"><div class="stat-value-sm accent-fast" id="raidTargetClickFast">0</div><div class="stat-label-sm">1 Click (Fast 6.7x)</div></div>
                            <div class="stat-col-val" style="text-align:right;"><div class="stat-value-sm accent-nor" id="raidTargetClickNor">0</div><div class="stat-label-sm">1 Click (Nor 5.0x)</div></div>
                        </div>
                    </div>
                </div>

                <!-- DEFENSE -->
                <div id="defenseOutput" class="hidden">
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-defense);">
                        <div class="stat-header"><div class="stat-title">SECRET DEFENSE PITY (4000)</div><div class="stat-icon">üõ°Ô∏è</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value" id="defPityRunsDisplay">0</div><div class="stat-label-sm">S·ªë l·∫ßn c·∫ßn ƒëi</div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val"><div class="stat-value-sm accent-fast" id="defPityTimeDisplay">0h</div><div class="stat-label-sm">Th·ªùi gian d·ª± ki·∫øn</div></div>
                        </div>
                    </div>
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-defense);">
                        <div class="stat-header"><div class="stat-title">K·∫æT QU·∫¢ T√çNH TO√ÅN WAVE <span id="defTargetWaveDisplay" style="color:#fff;">---</span></div><div class="stat-icon">üõ°Ô∏è</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value" id="defTargetHpDisplay">0</div><div class="stat-label-sm">HP Qu√°i D·ª± Ki·∫øn <span id="defModeLabel">(Solo)</span></div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val"><div class="stat-value-sm accent-fast" id="defTargetClickFast">0</div><div class="stat-label-sm">1 Click (Fast 6.7x)</div></div>
                            <div class="stat-col-val" style="text-align:right;"><div class="stat-value-sm accent-nor" id="defTargetClickNor">0</div><div class="stat-label-sm">1 Click (Nor 5.0x)</div></div>
                        </div>
                    </div>
                </div>

                <!-- SHADOW GATE -->
                <div id="shadowOutput" class="hidden">
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-shadow);">
                        <div class="stat-header"><div class="stat-title">SECRET SHADOW PITY (5000)</div><div class="stat-icon">üåë</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value" id="shadowPityRunsDisplay">0</div><div class="stat-label-sm">S·ªë l·∫ßn c·∫ßn ƒëi</div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val"><div class="stat-value-sm accent-fast" id="shadowPityTimeDisplay">0h</div><div class="stat-label-sm">Th·ªùi gian d·ª± ki·∫øn</div></div>
                        </div>
                    </div>
                    <div class="stat-card card-glow" style="margin-bottom: 20px; border-color: var(--col-shadow);">
                        <div class="stat-header"><div class="stat-title">K·∫æT QU·∫¢ T√çNH TO√ÅN WAVE <span id="shadowTargetWaveDisplay" style="color:#fff;">---</span></div><div class="stat-icon">üåë</div></div>
                        <div class="stat-row"><div class="stat-col-val"><div class="stat-value" id="shadowTargetHpDisplay">0</div><div class="stat-label-sm">HP Boss D·ª± Ki·∫øn</div></div></div>
                        <div class="stat-row" style="border-top:1px dashed #444; padding-top:12px; margin-top:12px;">
                            <div class="stat-col-val"><div class="stat-value-sm accent-fast" id="shadowTargetClickFast">0</div><div class="stat-label-sm">1 Click (Fast 6.7x)</div></div>
                            <div class="stat-col-val" style="text-align:right;"><div class="stat-value-sm accent-nor" id="shadowTargetClickNor">0</div><div class="stat-label-sm">1 Click (Nor 5.0x)</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">Made with love by Gemini</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId = '';
        const userSettingsPath = `artifacts/${appId}/users/`;
        const settingsDocName = 'calculator_settings';
        let spinMode = 1; 
        let defPlayers = 1; 

        const SCALING_FACTOR = 8.400;
        const BASE_COST_MAGNITUDE = 30; 
        const K_EXPONENT = 3; 
        const CPS_AUTO = 6.7;
        const CPS_NOR = 5.0; 

        const UNITS = [
            { name: '', exp: 0 }, { name: 'K', exp: 3 }, { name: 'M', exp: 6 }, { name: 'B', exp: 9 }, { name: 'T', exp: 12 }, 
            { name: 'Qa', exp: 15 }, { name: 'Qi', exp: 18 }, { name: 'Sx', exp: 21 }, { name: 'Sp', exp: 24 }, { name: 'Oc', exp: 27 }, 
            { name: 'No', exp: 30 }, { name: 'Dc', exp: 33 }, 
            { name: 'Ud', exp: 36 }, { name: 'Dd', exp: 39 }, 
            { name: 'Td', exp: 42 }, { name: 'Qad', exp: 45 }, { name: 'Qid', exp: 48 }, { name: 'Sxd', exp: 51 }, { name: 'Spd', exp: 54 }, 
            { name: 'Ocd', exp: 57 }, { name: 'Nod', exp: 60 }, { name: 'Dec', exp: 63 }, { name: 'Und', exp: 66 }, { name: 'Duo', exp: 69 },
            { name: 'Tri', exp: 72 }, { name: 'Qua', exp: 75 }, { name: 'Qui', exp: 78 }, { name: 'Six', exp: 81 }, 
            { name: 'Sep', exp: 84 }, { name: 'Oct', exp: 87 }, { name: 'Nuo', exp: 90 },
            { name: 'Dec', exp: 93 }, { name: 'Und', exp: 96 }, { name: 'Dud', exp: 99 }, 
            { name: 'Trd', exp: 102 }, { name: 'Qad', exp: 105 }, { name: 'Qid', exp: 108 }, 
            { name: 'Sxd', exp: 111 }, { name: 'Spd', exp: 114 }, { name: 'Ocd', exp: 117 }, 
            { name: 'Nod', exp: 120 }, { name: 'Vig', exp: 123 }
        ];

        const RANK_COSTS = {};

        function formatNumber(rawVal) {
            if (rawVal === 0) return "0";
            if (rawVal < 0) return "L·ªói";
            let unitIdx = 0;
            for (let i = UNITS.length - 1; i >= 0; i--) {
                if (rawVal >= Math.pow(10, UNITS[i].exp)) { unitIdx = i; break; }
            }
            const displayVal = rawVal / Math.pow(10, UNITS[unitIdx].exp);
            const unitName = UNITS[unitIdx].name === '' ? '' : UNITS[unitIdx].name;
            return `${parseFloat(displayVal.toFixed(2))}${unitName}`;
        }

        function formatBigTime(totalSeconds) {
            if (!isFinite(totalSeconds) || totalSeconds <= 0) return `0<span class="time-unit">s</span>`;
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            const sDisplay = totalSeconds < 60 ? totalSeconds.toFixed(2) : s;
            let html = "";
            if (h > 0) html += `${h}<span class="time-unit">h</span> `;
            if (m > 0 || h > 0) html += `${m}<span class="time-unit">m</span> `;
            html += `${sDisplay}<span class="time-unit">s</span>`;
            return html;
        }

        function formatTextTime(totalSeconds) {
            if (!isFinite(totalSeconds) || totalSeconds <= 0) return "0s";
            if (totalSeconds < 60) return totalSeconds.toFixed(2) + "s";
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return (h > 0 ? `${h}h ` : "") + `${m}m`;
        }

        function getRawVal(idVal, idUnit) {
            const val = parseFloat(document.getElementById(idVal).value) || 0;
            const unitIdx = parseInt(document.getElementById(idUnit).value) || 0;
            return val * Math.pow(10, UNITS[unitIdx].exp);
        }

        function buildRankCosts() {
            let currentCost = BASE_COST_MAGNITUDE * Math.pow(10, K_EXPONENT); 
            RANK_COSTS[0] = currentCost;
            for (let i = 1; i < 40; i++) {
                currentCost *= SCALING_FACTOR;
                RANK_COSTS[i] = currentCost;
            }
            // Rank 40 (40->41)
            currentCost = 1.14 * Math.pow(10, 42); // 1.14 Td
            RANK_COSTS[40] = currentCost;

            // Ranks 41-43 (Pre-existing specific values or logic)
            // 41->42: 9.94 Td
            RANK_COSTS[41] = 9.94 * Math.pow(10, 42);
            // 42->43: 86.48 Td
            RANK_COSTS[42] = 86.48 * Math.pow(10, 42);
            // 43->44: 2 Qad (From previous prompt, explicitly requested to keep lower ranks)
            RANK_COSTS[43] = 2.0 * Math.pow(10, 45);

            // New requests
            // r44 -> r45: 752.4 Td
            RANK_COSTS[44] = 752.4 * Math.pow(10, 42);
            // r45 -> r46: 56.95 Qad
            RANK_COSTS[45] = 56.95 * Math.pow(10, 45);
            // r46 -> r47: 2.36 Qid
            RANK_COSTS[46] = 2.36 * Math.pow(10, 48);

            // Ranks 47+ scaling
            // Calculate scaling factor from the last step? Or use fixed?
            // 2.36 Qid is a massive jump from 56.95 Qad (approx 41x).
            // If I use the old 8.7x factor from here:
            currentCost = RANK_COSTS[46];
            const SCALING_FACTOR_HIGH = 8.7;
            for (let i = 47; i <= 99; i++) {
                 currentCost *= SCALING_FACTOR_HIGH;
                 RANK_COSTS[i] = currentCost;
            }
        }

        window.handleInput = function(source) {
            const activeTab = getActiveTab();
            if (activeTab === 'rank') window.calculateRank();
            else if (activeTab === 'boss') window.calculateBoss();
            else if (activeTab === 'gacha') { window.calculateGacha(); window.calculateMasteryGained(); }
            else if (activeTab === 'raid') { window.calculateRaidTarget(); window.calculateRaidPity(); }
            else if (activeTab === 'defense') { window.calculateDefenseTarget(); window.calculateDefensePity(); }
            else if (activeTab === 'shadow') { window.calculateShadowTarget(); window.calculateShadowPity(); }
            saveSettings();
        };

        window.syncFromTo = function(srcId, destId) {
            const src = document.getElementById(srcId);
            const dest = document.getElementById(destId);
            if(src && dest) { dest.value = src.value; }
        }
        
        window.calculateMasteryGained = function() {
             const d = parseFloat(document.getElementById('timeDays').value) || 0;
             const h = parseFloat(document.getElementById('timeHours').value) || 0;
             const m = parseFloat(document.getElementById('timeMinutes').value) || 0;
             const totalSeconds = (d * 86400) + (h * 3600) + (m * 60);
             const masteryPerClick = getRawVal('clickValDup', 'clickUnitDup');
             const gainedAuto = masteryPerClick * CPS_AUTO * totalSeconds;
             const gainedNor = masteryPerClick * CPS_NOR * totalSeconds;
             document.getElementById('masteryGainedDisplay').innerText = formatNumber(gainedAuto);
             document.getElementById('masteryGainedNorDisplay').innerText = formatNumber(gainedNor);
             saveSettings();
        }

        function getActiveTab() {
            if (document.getElementById('rankTabBtn').classList.contains('active')) return 'rank';
            if (document.getElementById('bossTabBtn').classList.contains('active')) return 'boss';
            if (document.getElementById('gachaTabBtn').classList.contains('active')) return 'gacha';
            if (document.getElementById('raidTabBtn').classList.contains('active')) return 'raid';
            if (document.getElementById('defenseTabBtn').classList.contains('active')) return 'defense';
            if (document.getElementById('shadowTabBtn').classList.contains('active')) return 'shadow';
            return 'rank';
        }

        window.syncTargetRank = function() {
            let cr = parseInt(document.getElementById('currentRank').value) || 0;
            if(cr < 0) cr = 0; if(cr > 99) cr = 99;
            document.getElementById('currentRank').value = cr;
            let tr = cr + 1;
            if (tr > 100) tr = 100;
            document.getElementById('targetRank').value = tr;
            window.calculateRank();
            saveSettings();
        };

        window.showSection = function(sectionId, shouldSave = true) {
            const tabs = ['rank', 'boss', 'gacha', 'raid', 'defense', 'shadow'];
            tabs.forEach(t => {
                const btn = document.getElementById(t + 'TabBtn');
                if(btn) btn.classList.remove('active');
                const input = document.getElementById(t + 'Inputs');
                if(input) input.classList.add('hidden');
                const output = document.getElementById(t + 'Output');
                if(output) output.classList.add('hidden');
            });

            const activeBtn = document.getElementById(sectionId + 'TabBtn');
            if(activeBtn) activeBtn.classList.add('active');
            const activeInput = document.getElementById(sectionId + 'Inputs');
            if(activeInput) activeInput.classList.remove('hidden');
            const activeOutput = document.getElementById(sectionId + 'Output');
            if(activeOutput) activeOutput.classList.remove('hidden');

            if (sectionId === 'rank') window.calculateRank();
            else if (sectionId === 'boss') window.calculateBoss();
            else if (sectionId === 'gacha') { window.calculateGacha(); window.calculateMasteryGained(); }
            else if (sectionId === 'raid') { window.calculateRaidTarget(); window.calculateRaidPity(); }
            else if (sectionId === 'defense') { window.calculateDefenseTarget(); window.calculateDefensePity(); }
            else if (sectionId === 'shadow') { window.calculateShadowTarget(); window.calculateShadowPity(); }
            
            if(shouldSave) saveSettings();
        };

        window.setSpinMode = function(mode) {
            spinMode = mode;
            for(let i=1; i<=5; i++) {
                const btn = document.getElementById(`spin${i}x`);
                if(btn) btn.classList.toggle('active', mode === i);
            }
            window.calculateGacha();
            saveSettings();
        }

        window.calculateGacha = function() {
            const shards = getRawVal('gachaShardsVal', 'gachaShardsUnit');
            const costPerRoll = 10;
            const baseCycleTime = 1.5; 
            const totalRolls = Math.floor(shards / costPerRoll);
            const totalSeconds = Math.ceil(totalRolls / spinMode) * baseCycleTime;
            document.getElementById('gachaTimerDisplay').innerHTML = formatBigTime(totalSeconds);
            document.getElementById('gachaItemsDisplay').innerText = formatNumber(totalRolls);
        }
        
        window.calculateRaidPity = function() {
            const currentPity = parseInt(document.getElementById('raidPityCurrent').value) || 0;
            const wavesPerRun = parseInt(document.getElementById('raidWavePerRun').value) || 0;
            const target = 5000;
            if (wavesPerRun <= 0) {
                 document.getElementById('raidPityRunsDisplay').innerText = "0";
                 document.getElementById('raidPityTimeDisplay').innerText = "0h";
                 return;
            }
            const remaining = Math.max(0, target - currentPity);
            if (remaining === 0) {
                 document.getElementById('raidPityRunsDisplay').innerText = "Xong";
                 document.getElementById('raidPityTimeDisplay').innerText = "Xong";
                 return;
            }
            const runsNeeded = Math.ceil(remaining / wavesPerRun);
            const totalHours = runsNeeded / 2.0; 
            document.getElementById('raidPityRunsDisplay').innerText = formatNumber(runsNeeded);
            if(totalHours < 1) {
                const mins = Math.ceil(totalHours * 60);
                document.getElementById('raidPityTimeDisplay').innerText = `${mins}m`;
            } else {
                const h = Math.floor(totalHours);
                const m = Math.ceil((totalHours - h) * 60);
                document.getElementById('raidPityTimeDisplay').innerText = (m > 0) ? `${h}h ${m}m` : `${h}h`;
            }
        }

        window.calculateRaidTarget = function() {
            const targetStage = parseInt(document.getElementById('raidTargetStageInput').value);
            if (!targetStage) {
                document.getElementById('raidTargetStageDisplay').innerText = "---";
                document.getElementById('raidTargetHpDisplay').innerText = "0";
                document.getElementById('raidTargetClickFast').innerText = "0";
                document.getElementById('raidTargetClickNor').innerText = "0";
                return;
            }
            const refStage = parseInt(document.getElementById('raidRefStage').value) || 100;
            const refHp = getRawVal('raidRefHpVal', 'raidRefHpUnit');
            const growthRate = parseFloat(document.getElementById('raidGrowth').value) || 10.5;
            let diff = targetStage - refStage;
            let steps = diff / 5.0;
            let estimatedHp = refHp * Math.pow(growthRate, steps);
            let dpsReq = estimatedHp / 60;
            let reqClickFast = dpsReq / 6.7;
            let reqClickNor = dpsReq / 5.0;
            document.getElementById('raidTargetStageDisplay').innerText = targetStage;
            document.getElementById('raidTargetHpDisplay').innerText = formatNumber(estimatedHp);
            document.getElementById('raidTargetClickFast').innerText = formatNumber(reqClickFast);
            document.getElementById('raidTargetClickNor').innerText = formatNumber(reqClickNor);
        }

        window.setDefPlayers = function(p) {
            defPlayers = p;
            document.getElementById('defModeLabel').innerText = '(Solo)';
            // window.calculateDefense(); // No longer needed
            saveSettings();
        }

        window.calculateDefenseTarget = function() {
            const targetWave = parseInt(document.getElementById('defTargetWaveInput').value);
            if (!targetWave) {
                document.getElementById('defTargetWaveDisplay').innerText = "---";
                document.getElementById('defTargetHpDisplay').innerText = "0";
                document.getElementById('defTargetClickFast').innerText = "0";
                document.getElementById('defTargetClickNor').innerText = "0";
                return;
            }
            const refWave = parseInt(document.getElementById('defRefWave').value) || 50;
            const refHp = getRawVal('defRefHpVal', 'defRefHpUnit');
            const growthRate = parseFloat(document.getElementById('defGrowth').value) || 11;
            let steps = (targetWave - refWave) / 5.0;
            let estimatedHp = refHp * Math.pow(growthRate, steps);
            let dpsReq = estimatedHp / 60; 
            let reqClickFast = dpsReq / 6.7;
            let reqClickNor = dpsReq / 5.0;
            document.getElementById('defTargetWaveDisplay').innerText = targetWave;
            document.getElementById('defTargetHpDisplay').innerText = formatNumber(estimatedHp);
            document.getElementById('defTargetClickFast').innerText = formatNumber(reqClickFast);
            document.getElementById('defTargetClickNor').innerText = formatNumber(reqClickNor);
        }
        
        window.calculateDefensePity = function() {
            const currentPity = parseInt(document.getElementById('defPityCurrent').value) || 0;
            const wavesPerRun = parseInt(document.getElementById('defWavePerRun').value) || 0;
            const target = 4000;
            if (wavesPerRun <= 0) {
                 document.getElementById('defPityRunsDisplay').innerText = "0";
                 document.getElementById('defPityTimeDisplay').innerText = "0h";
                 return;
            }
            const remaining = Math.max(0, target - currentPity);
            if (remaining === 0) {
                 document.getElementById('defPityRunsDisplay').innerText = "Xong";
                 document.getElementById('defPityTimeDisplay').innerText = "Xong";
                 return;
            }
            const runsNeeded = Math.ceil(remaining / wavesPerRun);
            const totalHours = runsNeeded / 2.0; 
            document.getElementById('defPityRunsDisplay').innerText = formatNumber(runsNeeded);
            if(totalHours < 1) {
                const mins = Math.ceil(totalHours * 60);
                document.getElementById('defPityTimeDisplay').innerText = `${mins}m`;
            } else {
                const h = Math.floor(totalHours);
                const m = Math.ceil((totalHours - h) * 60);
                document.getElementById('defPityTimeDisplay').innerText = (m > 0) ? `${h}h ${m}m` : `${h}h`;
            }
        }

        window.calculateShadowTarget = function() {
            const targetWave = parseInt(document.getElementById('shadowTargetWaveInput').value);
            if (!targetWave) {
                document.getElementById('shadowTargetWaveDisplay').innerText = "---";
                document.getElementById('shadowTargetHpDisplay').innerText = "0";
                document.getElementById('shadowTargetClickFast').innerText = "0";
                document.getElementById('shadowTargetClickNor').innerText = "0";
                return;
            }
            const refWave = parseInt(document.getElementById('shadowRefWave').value) || 45;
            const refHp = getRawVal('shadowRefHpVal', 'shadowRefHpUnit');
            const growthRate = parseFloat(document.getElementById('shadowGrowth').value) || 10.7;
            
            let steps = (targetWave - refWave) / 5.0;
            let estimatedHp = refHp * Math.pow(growthRate, steps);
            let dpsReq = estimatedHp / 60; 
            let reqClickFast = dpsReq / 6.7;
            let reqClickNor = dpsReq / 5.0;
            
            document.getElementById('shadowTargetWaveDisplay').innerText = targetWave;
            document.getElementById('shadowTargetHpDisplay').innerText = formatNumber(estimatedHp);
            document.getElementById('shadowTargetClickFast').innerText = formatNumber(reqClickFast);
            document.getElementById('shadowTargetClickNor').innerText = formatNumber(reqClickNor);
        }

        window.calculateShadowPity = function() {
            const currentPity = parseInt(document.getElementById('shadowPityCurrent').value) || 0;
            const wavesPerRun = parseInt(document.getElementById('shadowWavePerRun').value) || 0;
            const target = 5000;
            
            if (wavesPerRun <= 0) {
                 document.getElementById('shadowPityRunsDisplay').innerText = "0";
                 document.getElementById('shadowPityTimeDisplay').innerText = "0h";
                 return;
            }
            
            const remaining = Math.max(0, target - currentPity);
            if (remaining === 0) {
                 document.getElementById('shadowPityRunsDisplay').innerText = "Xong";
                 document.getElementById('shadowPityTimeDisplay').innerText = "Xong";
                 return;
            }
            
            const runsNeeded = Math.ceil(remaining / wavesPerRun);
            const totalHours = runsNeeded / 2.0; 
            
            document.getElementById('shadowPityRunsDisplay').innerText = formatNumber(runsNeeded);
            
            if(totalHours < 1) {
                const mins = Math.ceil(totalHours * 60);
                document.getElementById('shadowPityTimeDisplay').innerText = `${mins}m`;
            } else {
                const h = Math.floor(totalHours);
                const m = Math.ceil((totalHours - h) * 60);
                document.getElementById('shadowPityTimeDisplay').innerText = (m > 0) ? `${h}h ${m}m` : `${h}h`;
            }
        }

        window.calculateRank = function() {
            const startRank = parseInt(document.getElementById('currentRank').value) || 0;
            const endRank = parseInt(document.getElementById('targetRank').value) || 1;
            const clickVal = getRawVal('clickVal', 'clickUnit');
            if (startRank >= endRank) {
                document.getElementById('totalCostDisplay').innerText = "---";
                document.getElementById('mainTimerDisplay').innerHTML = "Ho√†n th√†nh";
                return;
            }
            let totalCost = 0;
            for (let i = startRank; i < endRank; i++) { if (RANK_COSTS[i]) totalCost += RANK_COSTS[i]; }
            document.getElementById('totalCostDisplay').innerText = formatNumber(totalCost);
            const dpsAuto = clickVal * CPS_AUTO;
            const dpsNor = clickVal * CPS_NOR;
            document.getElementById('dpsDisplay').innerText = formatNumber(dpsAuto);
            document.getElementById('dpsNorDisplay').innerText = formatNumber(dpsNor);
            const timeAuto = dpsAuto > 0 ? totalCost / dpsAuto : 0;
            const timeNor = dpsNor > 0 ? totalCost / dpsNor : 0;
            document.getElementById('mainTimerDisplay').innerHTML = formatBigTime(timeAuto);
            document.getElementById('subTimerDisplay').innerText = formatTextTime(timeNor);
        };

        window.calculateBoss = function() {
            const bossHp = getRawVal('bossHpVal', 'bossHpUnit');
            const p1Dmg = getRawVal('damageVal', 'damageUnit');
            const p2Dmg = getRawVal('p2DmgVal', 'p2DmgUnit');
            const p3Dmg = getRawVal('p3DmgVal', 'p3DmgUnit');
            const p4Dmg = getRawVal('p4DmgVal', 'p4DmgUnit');
            const p5Dmg = getRawVal('p5DmgVal', 'p5DmgUnit');
            const p6Dmg = getRawVal('p6DmgVal', 'p6DmgUnit');
            const p7Dmg = getRawVal('p7DmgVal', 'p7DmgUnit');
            const p8Dmg = getRawVal('p8DmgVal', 'p8DmgUnit');
            const p9Dmg = getRawVal('p9DmgVal', 'p9DmgUnit');
            const p10Dmg = getRawVal('p10DmgVal', 'p10DmgUnit');
            
            const totalClickDmg = p1Dmg + p2Dmg + p3Dmg + p4Dmg + p5Dmg + p6Dmg + p7Dmg + p8Dmg + p9Dmg + p10Dmg;
            
            const totalEffectiveDmg = totalClickDmg * 1.25;

            const dpsDamageAuto = totalEffectiveDmg * CPS_AUTO;
            const timeBossAuto = dpsDamageAuto > 0 ? bossHp / dpsDamageAuto : 0;
            const timeBossNor = (totalEffectiveDmg * CPS_NOR) > 0 ? bossHp / (totalEffectiveDmg * CPS_NOR) : 0;

            document.getElementById('bossTimerAuto').innerHTML = formatBigTime(timeBossAuto);
            document.getElementById('bossTimerNor').innerText = formatTextTime(timeBossNor);
            document.getElementById('bossHpDisplay').innerText = formatNumber(bossHp);
            document.getElementById('damageDpsDisplay').innerText = formatNumber(dpsDamageAuto);
            
            const reqDmgBase = totalClickDmg * 0.15;
            const reqDmgEffective = totalEffectiveDmg * 0.15;
            
            document.getElementById('dmgRequiredDisplay').innerText = `C·∫ßn: ${formatNumber(reqDmgEffective)} (15%)`;
            
            let players = [ 
                { name: 'P1 (B·∫°n)', dmg: p1Dmg }, { name: 'P2', dmg: p2Dmg }, { name: 'P3', dmg: p3Dmg }, { name: 'P4', dmg: p4Dmg }, { name: 'P5', dmg: p5Dmg }, { name: 'P6', dmg: p6Dmg },
                { name: 'P7', dmg: p7Dmg }, { name: 'P8', dmg: p8Dmg }, { name: 'P9', dmg: p9Dmg }, { name: 'P10', dmg: p10Dmg }
            ];
            
            let tableHtml = `<tr><th style="text-align:left;">Ng∆∞·ªùi ch∆°i</th><th style="text-align:right;">S√°t th∆∞∆°ng TB (1 Click)</th><th style="text-align:right;">Tr·∫°ng th√°i</th></tr>`;
            
            players.forEach(p => {
                if(p.dmg > 0) { 
                    let isOk = p.dmg >= reqDmgBase;
                    let statusClass = isOk ? 'status-ok' : 'status-fail';
                    let statusText = isOk ? 'ƒê·ªß ƒêK' : 'Thi·∫øu';
                    let percent = (p.dmg / totalClickDmg) * 100;
                    
                    let effectivePlayerDmg = p.dmg * 1.25;
                    
                    tableHtml += `<tr><td style="text-align:left;">${p.name}</td><td>${formatNumber(effectivePlayerDmg)} <span style="font-size:10px; color:#666">(${percent.toFixed(1)}%)</span></td><td class="${statusClass}">${statusText}</td></tr>`;
                }
            });
            
            if(totalClickDmg === 0) tableHtml += `<tr><td colspan="3" style="text-align:center; color:#666;">Ch∆∞a nh·∫≠p s√°t th∆∞∆°ng</td></tr>`;
            document.getElementById('bossTeamTable').innerHTML = tableHtml;
        };

        function initUI() {
            buildRankCosts();
            const unitSelects = [
                'clickUnit', 'bossHpUnit', 'damageUnit', 'currentMasteryUnit', 'clickUnitDup', 
                'gachaShardsUnit', 'raidRefHpUnit', 'defRefHpUnit', 'shadowRefHpUnit',
                'p2DmgUnit', 'p3DmgUnit', 'p4DmgUnit', 'p5DmgUnit', 'p6DmgUnit',
                'p7DmgUnit', 'p8DmgUnit', 'p9DmgUnit', 'p10DmgUnit'
            ];
            unitSelects.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = '';
                UNITS.forEach((u, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = u.name || '';
                    if(u.name === 'K') opt.selected = true;
                    if(id === 'raidRefHpUnit' && u.name === 'Dc') opt.selected = true;
                    if(id === 'defRefHpUnit' && u.name === 'Dd') opt.selected = true; 
                    if(id === 'shadowRefHpUnit' && u.name === 'Td') opt.selected = true;
                    el.appendChild(opt);
                });
            });
            
            const mainClickVal = document.getElementById('clickVal').value;
            const mainClickUnit = document.getElementById('clickUnit').value;
            document.getElementById('clickValDup').value = mainClickVal;
            document.getElementById('clickUnitDup').value = mainClickUnit;

            const dcIndex = UNITS.findIndex(u => u.name === 'Dc');
            if(dcIndex > -1 && document.getElementById('raidRefHpUnit')) document.getElementById('raidRefHpUnit').value = dcIndex;
            const ddIndex = UNITS.findIndex(u => u.name === 'Dd');
            if(ddIndex > -1 && document.getElementById('defRefHpUnit')) document.getElementById('defRefHpUnit').value = ddIndex;
            const tdIndex = UNITS.findIndex(u => u.name === 'Td');
            if(tdIndex > -1 && document.getElementById('shadowRefHpUnit')) document.getElementById('shadowRefHpUnit').value = tdIndex;
            
            initCardGlow(); 
        }

        function initCardGlow() {
            document.querySelectorAll('.card-glow').forEach(card => {
                card.onmousemove = e => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                };
            });
        }

        async function saveSettings() {
            if (!userId || !db) return;
            const settings = {
                activeTab: document.querySelector('.nav-btn.active').id.replace('TabBtn',''),
                damageVal: document.getElementById('damageVal').value,
                damageUnit: document.getElementById('damageUnit').value,
                p2DmgVal: document.getElementById('p2DmgVal').value,
                p2DmgUnit: document.getElementById('p2DmgUnit').value,
                p3DmgVal: document.getElementById('p3DmgVal').value,
                p3DmgUnit: document.getElementById('p3DmgUnit').value,
                p4DmgVal: document.getElementById('p4DmgVal').value,
                p4DmgUnit: document.getElementById('p4DmgUnit').value,
                p5DmgVal: document.getElementById('p5DmgVal').value,
                p5DmgUnit: document.getElementById('p5DmgUnit').value,
                p6DmgVal: document.getElementById('p6DmgVal').value,
                p6DmgUnit: document.getElementById('p6DmgUnit').value,
                p7DmgVal: document.getElementById('p7DmgVal').value,
                p7DmgUnit: document.getElementById('p7DmgUnit').value,
                p8DmgVal: document.getElementById('p8DmgVal').value,
                p8DmgUnit: document.getElementById('p8DmgUnit').value,
                p9DmgVal: document.getElementById('p9DmgVal').value,
                p9DmgUnit: document.getElementById('p9DmgUnit').value,
                p10DmgVal: document.getElementById('p10DmgVal').value,
                p10DmgUnit: document.getElementById('p10DmgUnit').value,
                
                clickVal: document.getElementById('clickVal').value,
                clickUnit: document.getElementById('clickUnit').value,

                currentRank: document.getElementById('currentRank').value,
                targetRank: document.getElementById('targetRank').value,
                bossHpVal: document.getElementById('bossHpVal').value,
                bossHpUnit: document.getElementById('bossHpUnit').value,
                
                timeDays: document.getElementById('timeDays').value,
                timeHours: document.getElementById('timeHours').value,
                timeMinutes: document.getElementById('timeMinutes').value,
                
                gachaShardsVal: document.getElementById('gachaShardsVal').value,
                gachaShardsUnit: document.getElementById('gachaShardsUnit').value,
                spinMode: spinMode,
                raidRefStage: document.getElementById('raidRefStage').value,
                raidRefHpVal: document.getElementById('raidRefHpVal').value,
                raidRefHpUnit: document.getElementById('raidRefHpUnit').value,
                raidGrowth: document.getElementById('raidGrowth').value,
                raidTargetStageInput: document.getElementById('raidTargetStageInput').value,
                raidPityCurrent: document.getElementById('raidPityCurrent').value,
                raidWavePerRun: document.getElementById('raidWavePerRun').value,

                defRefWave: document.getElementById('defRefWave').value,
                defRefHpVal: document.getElementById('defRefHpVal').value,
                defRefHpUnit: document.getElementById('defRefHpUnit').value,
                defGrowth: document.getElementById('defGrowth').value,
                defTargetWaveInput: document.getElementById('defTargetWaveInput').value,
                defPityCurrent: document.getElementById('defPityCurrent').value,
                defWavePerRun: document.getElementById('defWavePerRun').value,
                defPlayers: defPlayers,

                // SHADOW SAVING
                shadowRefWave: document.getElementById('shadowRefWave').value,
                shadowRefHpVal: document.getElementById('shadowRefHpVal').value,
                shadowRefHpUnit: document.getElementById('shadowRefHpUnit').value,
                shadowGrowth: document.getElementById('shadowGrowth').value,
                shadowTargetWaveInput: document.getElementById('shadowTargetWaveInput').value,
                shadowPityCurrent: document.getElementById('shadowPityCurrent').value,
                shadowWavePerRun: document.getElementById('shadowWavePerRun').value
            };
            try { await setDoc(doc(db, userSettingsPath, userId, 'app_data', settingsDocName), settings); } 
            catch (e) { console.error(e); }
        }

        async function loadSettings() {
            if (!userId || !db) return;
            try {
                const snap = await getDoc(doc(db, userSettingsPath, userId, 'app_data', settingsDocName));
                if (snap.exists()) {
                    const s = snap.data();
                    document.getElementById('currentMasteryVal').value = s.currentMasteryVal || '0';
                    document.getElementById('currentMasteryUnit').value = s.currentMasteryUnit || '1';
                    document.getElementById('clickVal').value = s.clickVal || '0';
                    document.getElementById('clickUnit').value = s.clickUnit || '1';
                    document.getElementById('clickValDup').value = s.clickVal || '0';
                    document.getElementById('clickUnitDup').value = s.clickUnit || '1';
                    document.getElementById('damageVal').value = s.damageVal || '0';
                    document.getElementById('damageUnit').value = s.damageUnit || '1';
                    
                    if(s.p2DmgVal) document.getElementById('p2DmgVal').value = s.p2DmgVal;
                    if(s.p2DmgUnit) document.getElementById('p2DmgUnit').value = s.p2DmgUnit;
                    if(s.p3DmgVal) document.getElementById('p3DmgVal').value = s.p3DmgVal;
                    if(s.p3DmgUnit) document.getElementById('p3DmgUnit').value = s.p3DmgUnit;
                    if(s.p4DmgVal) document.getElementById('p4DmgVal').value = s.p4DmgVal;
                    if(s.p4DmgUnit) document.getElementById('p4DmgUnit').value = s.p4DmgUnit;
                    if(s.p5DmgVal) document.getElementById('p5DmgVal').value = s.p5DmgVal;
                    if(s.p5DmgUnit) document.getElementById('p5DmgUnit').value = s.p5DmgUnit;
                    if(s.p6DmgVal) document.getElementById('p6DmgVal').value = s.p6DmgVal;
                    if(s.p6DmgUnit) document.getElementById('p6DmgUnit').value = s.p6DmgUnit;
                    if(s.p7DmgVal) document.getElementById('p7DmgVal').value = s.p7DmgVal;
                    if(s.p7DmgUnit) document.getElementById('p7DmgUnit').value = s.p7DmgUnit;
                    if(s.p8DmgVal) document.getElementById('p8DmgVal').value = s.p8DmgVal;
                    if(s.p8DmgUnit) document.getElementById('p8DmgUnit').value = s.p8DmgUnit;
                    if(s.p9DmgVal) document.getElementById('p9DmgVal').value = s.p9DmgVal;
                    if(s.p9DmgUnit) document.getElementById('p9DmgUnit').value = s.p9DmgUnit;
                    if(s.p10DmgVal) document.getElementById('p10DmgVal').value = s.p10DmgVal;
                    if(s.p10DmgUnit) document.getElementById('p10DmgUnit').value = s.p10DmgUnit;

                    document.getElementById('currentRank').value = s.currentRank || '0';
                    document.getElementById('targetRank').value = s.targetRank || '1';
                    document.getElementById('bossHpVal').value = s.bossHpVal || '0';
                    document.getElementById('bossHpUnit').value = s.bossHpUnit || '1';
                    
                    document.getElementById('timeDays').value = s.timeDays || '0';
                    document.getElementById('timeHours').value = s.timeHours || '0';
                    document.getElementById('timeMinutes').value = s.timeMinutes || '0';
                    
                    document.getElementById('gachaShardsVal').value = s.gachaShardsVal || '0';
                    document.getElementById('gachaShardsUnit').value = s.gachaShardsUnit || '1';
                    if(s.spinMode) window.setSpinMode(s.spinMode);

                    if(s.raidRefStage) document.getElementById('raidRefStage').value = s.raidRefStage;
                    if(s.raidRefHpVal) document.getElementById('raidRefHpVal').value = s.raidRefHpVal;
                    if(s.raidRefHpUnit) document.getElementById('raidRefHpUnit').value = s.raidRefHpUnit;
                    if(s.raidGrowth) document.getElementById('raidGrowth').value = s.raidGrowth;
                    if(s.raidTargetStageInput) document.getElementById('raidTargetStageInput').value = s.raidTargetStageInput;
                    if(s.raidPityCurrent) document.getElementById('raidPityCurrent').value = s.raidPityCurrent;
                    if(s.raidWavePerRun) document.getElementById('raidWavePerRun').value = s.raidWavePerRun;

                    if(s.defRefWave) document.getElementById('defRefWave').value = s.defRefWave;
                    if(s.defRefHpVal) document.getElementById('defRefHpVal').value = s.defRefHpVal;
                    if(s.defRefHpUnit) document.getElementById('defRefHpUnit').value = s.defRefHpUnit;
                    if(s.defGrowth) document.getElementById('defGrowth').value = s.defGrowth;
                    if(s.defTargetWaveInput) document.getElementById('defTargetWaveInput').value = s.defTargetWaveInput;
                    if(s.defPityCurrent) document.getElementById('defPityCurrent').value = s.defPityCurrent;
                    if(s.defWavePerRun) document.getElementById('defWavePerRun').value = s.defWavePerRun;
                    if(s.defPlayers) window.setDefPlayers(s.defPlayers);

                    if(s.shadowRefWave) document.getElementById('shadowRefWave').value = s.shadowRefWave;
                    if(s.shadowRefHpVal) document.getElementById('shadowRefHpVal').value = s.shadowRefHpVal;
                    if(s.shadowRefHpUnit) document.getElementById('shadowRefHpUnit').value = s.shadowRefHpUnit;
                    if(s.shadowGrowth) document.getElementById('shadowGrowth').value = s.shadowGrowth;
                    if(s.shadowTargetWaveInput) document.getElementById('shadowTargetWaveInput').value = s.shadowTargetWaveInput;
                    if(s.shadowPityCurrent) document.getElementById('shadowPityCurrent').value = s.shadowPityCurrent;
                    if(s.shadowWavePerRun) document.getElementById('shadowWavePerRun').value = s.shadowWavePerRun;

                    const tab = (s.activeTab === 'updates') ? 'rank' : (s.activeTab || 'rank');
                    setTimeout(() => { window.showSection(tab, false); }, 50);
                } else { window.handleInput(); }
            } catch (e) { window.handleInput(); }
        }
        
        window.onload = () => { initUI(); setupFirebase(); };
    </script>
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }
    </script>
</body>
</html>
